---
title: "Model Inference of discrete BNs"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Model Inference of discrete BNs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
# Clear working environment
rm(list=ls())

# Load libraries
library(bnaiaR)
library(dplyr)
library(bnlearn)


# Save plots as files? 
SAVEPLOTS <- F
PLOTPATH <- paste0(Sys.getenv("PLOTPATH"), "/fourierplots")
PLOTFORMAT <- "pdf" # "pdf", "svg" or "png"
PLOTWIDTH = 16
PLOTHEIGHT = 9
```

# Load discrete additive mixed-effects BN

```{r message=FALSE, warning=FALSE}
load(paste0(PLOTPATH, "/discrete_BN_SL_additive_bic_mixedeffects.RData"))
```


```{r}
data <- tobesaved$madbn_data %>%
  mutate(positive_famillial_history = factor(positive_famillial_history))
bl <- tobesaved$madbn_bl
avg <- tobesaved$madbn_avg
bb <- tobesaved$madbn_boot
```

```{r}
strength.plot(avg,
              bb,
              main = "discrete additive mixed-effects BN",
              # sub = "SL: tabu\nth.=0.3\nScore=BIC",
              shape = "rectangle")
```



# Inference by querying


```{r}
madbn_fit <- bn.fit(data = data, x = avg)
```

```{r}
# remove study_source
avg_mod <- bnlearn::remove.node(avg, "study_source")
bb_mod <-  bb %>%
  filter(from != "study_source") %>%
    filter(to != "study_source")
attr(bb_mod, "nodes") <- attr(bb_mod, "nodes")[-10]
data_mod <- data %>%
  select(-c("study_source"))

strength.plot(avg_mod,
              bb_mod,
              main = "discrete additive mixed-effects BN",
              sub = "Fitting w/o study_source",
              shape = "rectangle")

if (SAVEPLOTS){
  PLOTNAME <- "admeBN_fitting_wo_studysource"  
  if(PLOTFORMAT == "svg"){
    dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "png"){
    dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "pdf"){
    dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } 
} 

madbn_fit_mod <- bn.fit(data = data_mod, x = avg_mod)
```


```{r export as HUGIN flat network format}
bnlearn::write.net(file = paste0(PLOTPATH, "/adme_fitted.net"), fitted = madbn_fit)
bnlearn::write.net(file = paste0(PLOTPATH, "/adme_fitted_wo_studysource.net"), fitted = madbn_fit_mod)
```



```{r}
plot(madbn_fit_mod$hpt_aware$prob)
```

Younger IA patients are less frequently aware of HBP. The older the more aware.


```{r }
par(mfrow = c(2,2))
sim = cpdist(madbn_fit, nodes = c("hpt_aware", "age_diag_group"), n = 10^4, evidence = (IAruptured == "yes"))
plot(sim, col = "grey",
     main = "IAruptured == yes")

sim = cpdist(madbn_fit, nodes = c("hpt_aware", "age_diag_group"), n = 10^4, evidence = (IAruptured == "no"))
plot(sim, col = "grey",
     main = "IAruptured == no")

sim = cpdist(madbn_fit, nodes = c("age_diag_group", "hpt_aware"), n = 10^4, evidence = (IAruptured == "yes"))
plot(sim, col = "grey",
     main = "IAruptured == yes")

sim = cpdist(madbn_fit, nodes = c("age_diag_group", "hpt_aware"), n = 10^4, evidence = (IAruptured == "no"))
plot(sim, col = "grey",
     main = "IAruptured == no")

if (SAVEPLOTS){
  PLOTNAME <- "infquerry_rupture-age-hpt"  
  if(PLOTFORMAT == "svg"){
    dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "png"){
    dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "pdf"){
    dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTWIDTH)
    dev.off()
  } 
}
```


```{r }
par(mfrow = c(1,2))
sim = cpdist(madbn_fit, nodes = c("age_diag_group"), n = 10^5, evidence = (IAruptured == "yes"))
plot(prop.table(table(sim)), col = "grey",
     main = "IAruptured == yes")

sim = cpdist(madbn_fit, nodes = c("age_diag_group"), n = 10^5, evidence = (IAruptured == "no"))
plot(prop.table(table(sim)), col = "grey",
     main = "IAruptured == no")

# SAVEPLOTS <- F
if (SAVEPLOTS){
  PLOTNAME <- "infquerry_rupture-age"  
  if(PLOTFORMAT == "svg"){
    dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "png"){
    dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "pdf"){
    dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTWIDTH)
    dev.off()
  } 
} 
```

Chronological age at IA diagnosis is higher for unruptured IAs than ruptured.

```{r}
par(mfrow=c(2,2))
sim = cpdist(madbn_fit, nodes = c("smoking_current_notcurrent", "IAsize_diag_grouped_merged"), n = 10^5, evidence = (IAruptured == "yes"))
plot(prop.table(table(sim)), col = "grey",
     main = 'IAruptured == "yes"')

sim = cpdist(madbn_fit, nodes = c("smoking_current_notcurrent", "IAsize_diag_grouped_merged"), n = 10^5, evidence = (IAruptured == "no"))
plot(prop.table(table(sim)), col = "grey",
     main = 'IAruptured == "no"')

sim = cpdist(madbn_fit, nodes = c("smoking_current_notcurrent", "IAsize_diag_grouped_merged"), n = 10^5, evidence = (IAruptured == "yes"))
barplot(prop.table(table(sim)), col = "grey",
     main = 'IAruptured == "yes"')

sim = cpdist(madbn_fit, nodes = c("smoking_current_notcurrent", "IAsize_diag_grouped_merged"), n = 10^5, evidence = (IAruptured == "no"))
barplot(prop.table(table(sim)), col = "grey",
     main = 'IAruptured == "no"')

if (SAVEPLOTS){
  PLOTNAME <- "infquerry_rupture-smoking-size"
  if(PLOTFORMAT == "svg"){
    dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "png"){
    dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "pdf"){
    dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTWIDTH)
    dev.off()
  } 
}
```


```{r}
par(mfrow=c(2,2))
sim = cpdist(madbn_fit, nodes = c("smoking_current_notcurrent", "age_diag_group"), n = 10^5, evidence = (IAruptured == "yes"))
plot(prop.table(table(sim)), col = "grey",
     main = 'IAruptured == "yes"')
round(prop.table(table(sim)), 2)

sim = cpdist(madbn_fit, nodes = c("smoking_current_notcurrent", "age_diag_group"), n = 10^5, evidence = (IAruptured == "no"))
plot(prop.table(table(sim)), col = "grey",
     main = 'IAruptured == "no"')
round(prop.table(table(sim)), 2)

sim = cpdist(madbn_fit, nodes = c("smoking_current_notcurrent", "age_diag_group"), n = 10^5, evidence = (IAruptured == "yes"))
barplot(prop.table(table(sim)), col = "grey",
     main = 'IAruptured == "yes"')
round(prop.table(table(sim)), 2)

sim = cpdist(madbn_fit, nodes = c("smoking_current_notcurrent", "age_diag_group"), n = 10^5, evidence = (IAruptured == "no"))
barplot(prop.table(table(sim)), col = "grey",
     main = 'IAruptured == "no"')
round(prop.table(table(sim)), 2)

if (SAVEPLOTS){
  PLOTNAME <- "infquerry_rupture-smoking-age"
  if(PLOTFORMAT == "svg"){
    dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "png"){
    dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "pdf"){
    dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTWIDTH)
    dev.off()
  } 
}
```


```{r}
par(mfrow=c(2,2))
sim = cpdist(madbn_fit, nodes = c("IAsize_diag_grouped_merged", "age_diag_group"), n = 10^5, evidence = (smoking_current_notcurrent == "current" & IAruptured == "yes"))
plot(prop.table(table(sim)), col = "grey",
     main = 'smoking_current_notcurrent == "current" & IAruptured == "yes"')

sim = cpdist(madbn_fit, nodes = c("IAsize_diag_grouped_merged", "age_diag_group"), n = 10^5, evidence = (smoking_current_notcurrent == "current" & IAruptured == "no"))
plot(prop.table(table(sim)), col = "grey",
     main = 'smoking_current_notcurrent == "current" & IAruptured == "no"')

sim = cpdist(madbn_fit, nodes = c("IAsize_diag_grouped_merged", "age_diag_group"), n = 10^5, evidence = (smoking_current_notcurrent == "current" & IAruptured == "yes"))
barplot(prop.table(table(sim)), col = "grey",
     main = 'smoking_current_notcurrent == "current" & IAruptured == "yes"')

sim = cpdist(madbn_fit, nodes = c("IAsize_diag_grouped_merged", "age_diag_group"), n = 10^5, evidence = (smoking_current_notcurrent == "current" & IAruptured == "no"))
barplot(prop.table(table(sim)), col = "grey",
     main = 'smoking_current_notcurrent == "current" & IAruptured == "no"')

if (SAVEPLOTS){
  PLOTNAME <- "infquerry_smoking-age-size"
  if(PLOTFORMAT == "svg"){
    dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "png"){
    dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "pdf"){
    dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTWIDTH)
    dev.off()
  } 
}
```

```{r}
par(mfrow=c(2,2))
sim = cpdist(madbn_fit, nodes = c("gender", "IAlocation_group"), n = 10^4, evidence = (IAruptured == "yes"))
plot(prop.table(table(sim)),
     main = 'IAruptured == "yes"')
round(prop.table(table(sim)), 2)
           
sim = cpdist(madbn_fit, nodes = c("gender", "IAlocation_group"), n = 10^4, evidence = (IAruptured == "no"))
plot(prop.table(table(sim)),
     main = 'IAruptured == "no"')
round(prop.table(table(sim)), 2)

sim = cpdist(madbn_fit, nodes = c("gender", "IAlocation_group"), n = 10^4, evidence = (IAruptured == "yes"))
barplot(prop.table(table(sim)),
     main = 'IAruptured == "yes"')

sim = cpdist(madbn_fit, nodes = c("gender", "IAlocation_group"), n = 10^4, evidence = (IAruptured == "no"))
barplot(prop.table(table(sim)),
     main = 'IAruptured == "no"')

if (SAVEPLOTS){
  PLOTNAME <- "infquerry_rupture-location-gender"
  if(PLOTFORMAT == "svg"){
    dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "png"){
    dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "pdf"){
    dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTWIDTH)
    dev.off()
  } 
}
```

Females have unruptured IAs more frequently detected in low risk locations than males.

```{r}
par(mfrow=c(2,2))
sim = cpdist(madbn_fit, nodes = c("age_diag_group", "IAruptured"), n = 10^4, evidence = (smoking_current_notcurrent == "current" & hpt_aware == "yes" & positive_famillial_history == "yes"))
plot(prop.table(table(sim)), col = "grey",
     main = 'smoking_current_notcurrent == "current", hpt_aware = "yes", positive_famillial_history = "yes"')
sim = cpdist(madbn_fit, nodes = c("age_diag_group", "IAruptured"), n = 10^4, evidence = (smoking_current_notcurrent == "not_current" & hpt_aware == "no" & positive_famillial_history == "no"))
plot(prop.table(table(sim)), col = "grey",
     main = 'smoking_current_notcurrent == "not_current" & hpt_aware == "no" & positive_famillial_history == "no"')

sim = cpdist(madbn_fit, nodes = c("age_diag_group", "IAruptured"), n = 10^4, evidence = (smoking_current_notcurrent == "current" & hpt_aware == "yes" & positive_famillial_history == "yes"))
barplot(prop.table(table(sim)), col = "grey",
     main = 'smoking_current_notcurrent == "current", hpt_aware = "yes", positive_famillial_history = "yes"')
sim = cpdist(madbn_fit, nodes = c("age_diag_group", "IAruptured"), n = 10^4, evidence = (smoking_current_notcurrent == "not_current" & hpt_aware == "no" & positive_famillial_history == "no"))
barplot(prop.table(table(sim)), col = "grey",
     main = 'smoking_current_notcurrent == "not_current" & hpt_aware == "no" & positive_famillial_history == "no"')

if (SAVEPLOTS){
  PLOTNAME <- "infquerry_rupture-age-smoking-hbp-family"
  if(PLOTFORMAT == "svg"){
    dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "png"){
    dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "pdf"){
    dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH*1.2, height = PLOTWIDTH)
    dev.off()
  } 
}
```

```{r Corresponding to Morel et al. 2022, Fig 3a-b }
par(mfrow=c(2,2))
sim = cpdist(madbn_fit, nodes = c("multipleIAs", "IAlocation_group"), n = 10^4, evidence = (IAruptured == "yes"))
barplot(prop.table(table(sim)), col = "grey",
        ylim = c(0,0.8),
     main = "P(multipleIAs, IAlocation_group | IAruptured == 'yes')")
prop.table(table(sim))

sim = cpdist(madbn_fit, nodes = c("multipleIAs", "IAlocation_group"), n = 10^4, evidence = (IAruptured == "no"))
barplot(prop.table(table(sim)), col = "grey",
        ylim = c(0,0.8),
     main = "P(multipleIAs, IAlocation_group | IAruptured == 'no')")
prop.table(table(sim))

# if (SAVEPLOTS){
#   PLOTNAME <- "infquerry_rupture-multiple-location_barplt"
#   if(PLOTFORMAT == "svg"){
#     dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
#     dev.off()
#   } else if(PLOTFORMAT == "png"){
#     dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
#     dev.off()
#   } else if(PLOTFORMAT == "pdf"){
#     dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
#     dev.off()
#   } 
# }
# 
# par(mfrow=c(1,2))
sim = cpdist(madbn_fit, nodes = c("multipleIAs", "IAlocation_group"), n = 10^4, evidence = (IAruptured == "yes"))
plot(prop.table(table(sim)), col = "grey",
        ylim = c(0,0.8),
     main = "P(multipleIAs, IAlocation_group | IAruptured == 'yes')")
prop.table(table(sim))

sim = cpdist(madbn_fit, nodes = c("multipleIAs", "IAlocation_group"), n = 10^4, evidence = (IAruptured == "no"))
plot(prop.table(table(sim)), col = "grey",
        ylim = c(0,0.8),
     main = "P(multipleIAs, IAlocation_group | IAruptured == 'no')")
prop.table(table(sim))

if (SAVEPLOTS){
  PLOTNAME <- "infquerry_rupture-multiple-location"
  if(PLOTFORMAT == "svg"){
    dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "png"){
    dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "pdf"){
    dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTWIDTH)
    dev.off()
  } 
}
```

```{r Corresponding to Morel et al. 2022, Fig 3c}
par(mfrow=c(2,2))
sim = cpdist(madbn_fit, nodes = c("IAsize_diag_grouped_merged", "IAlocation_group"), n = 10^4, evidence = (IAruptured == "yes"))
barplot(prop.table(table(sim)), col = "grey",
        ylim = c(0,0.8),
     main = "P(IAsize_diag_grouped_merged, IAlocation_group | IAruptured == 'yes')")
prop.table(table(sim))

sim = cpdist(madbn_fit, nodes = c("IAsize_diag_grouped_merged", "IAlocation_group"), n = 10^4, evidence = (IAruptured == "no"))
barplot(prop.table(table(sim)), col = "grey",
        ylim = c(0,0.8),
     main = "P(IAsize_diag_grouped_merged, IAlocation_group | IAruptured == 'no')")
prop.table(table(sim))

# if (SAVEPLOTS){
#   PLOTNAME <- "infquerry_rupture-multiple-location_barplt"
#   if(PLOTFORMAT == "svg"){
#     dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
#     dev.off()
#   } else if(PLOTFORMAT == "png"){
#     dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
#     dev.off()
#   } else if(PLOTFORMAT == "pdf"){
#     dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
#     dev.off()
#   } 
# }
# 
# par(mfrow=c(1,2))
sim = cpdist(madbn_fit, nodes = c("IAsize_diag_grouped_merged", "IAlocation_group"), n = 10^4, evidence = (IAruptured == "yes"))
plot(prop.table(table(sim)), col = "grey",
        ylim = c(0,0.8),
     main = "P(IAsize_diag_grouped_merged, IAlocation_group | IAruptured == 'yes')")
prop.table(table(sim))

sim = cpdist(madbn_fit, nodes = c("IAsize_diag_grouped_merged", "IAlocation_group"), n = 10^4, evidence = (IAruptured == "no"))
plot(prop.table(table(sim)), col = "grey",
        ylim = c(0,0.8),
     main = "P(IAsize_diag_grouped_merged, IAlocation_group | IAruptured == 'no')")
prop.table(table(sim))

if (SAVEPLOTS){
  PLOTNAME <- "infquerry_rupture-size-location"
  if(PLOTFORMAT == "svg"){
    dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "png"){
    dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "pdf"){
    dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTWIDTH)
    dev.off()
  } 
}
```

```{r Corresponding to Morel et al. 2022, Fig 3d}
par(mfrow=c(2,2))
sim = cpdist(madbn_fit, nodes = c("age_diag_group", "IAlocation_group"), n = 10^4, evidence = (IAruptured == "yes"))
barplot(prop.table(table(sim)), col = "grey",
        ylim = c(0,0.8),
     main = "P(age_diag_group, IAlocation_group | IAruptured == 'yes')")
prop.table(table(sim))

sim = cpdist(madbn_fit, nodes = c("age_diag_group", "IAlocation_group"), n = 10^4, evidence = (IAruptured == "no"))
barplot(prop.table(table(sim)), col = "grey",
        ylim = c(0,0.8),
     main = "P(age_diag_group, IAlocation_group | IAruptured == 'no')")
prop.table(table(sim))

# if (SAVEPLOTS){
#   PLOTNAME <- "infquerry_rupture-multiple-location_barplt"
#   if(PLOTFORMAT == "svg"){
#     dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
#     dev.off()
#   } else if(PLOTFORMAT == "png"){
#     dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
#     dev.off()
#   } else if(PLOTFORMAT == "pdf"){
#     dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
#     dev.off()
#   } 
# }
# 
# par(mfrow=c(1,2))
sim = cpdist(madbn_fit, nodes = c("age_diag_group", "IAlocation_group"), n = 10^4, evidence = (IAruptured == "yes"))
plot(prop.table(table(sim)), col = "grey",
        ylim = c(0,0.8),
     main = "P(age_diag_group, IAlocation_group | IAruptured == 'yes')")
prop.table(table(sim))

sim = cpdist(madbn_fit, nodes = c("age_diag_group", "IAlocation_group"), n = 10^4, evidence = (IAruptured == "no"))
plot(prop.table(table(sim)), col = "grey",
        ylim = c(0,0.8),
     main = "P(age_diag_group, IAlocation_group | IAruptured == 'no')")
prop.table(table(sim))

if (SAVEPLOTS){
  PLOTNAME <- "infquerry_rupture-age-location"
  if(PLOTFORMAT == "svg"){
    dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "png"){
    dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "pdf"){
    dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTWIDTH)
    dev.off()
  } 
}
```

```{r}
par(mfrow=c(1,2))
sim = cpdist(madbn_fit, nodes = c("multipleIAs"), n = 10^4, evidence = (hpt_aware == "yes"))
barplot(prop.table(table(sim)), col = "grey",
        ylim = c(0,0.8),
     main = "P(multipleIAs | hpt_aware == 'yes')")
prop.table(table(sim))

sim = cpdist(madbn_fit, nodes = c("multipleIAs"), n = 10^4, evidence = (hpt_aware == "no"))
barplot(prop.table(table(sim)), col = "grey",
     ylim = c(0,0.8), 
     main = "P(multipleIAs | hpt_aware == 'no')")
prop.table(table(sim))

if (SAVEPLOTS){
  PLOTNAME <- "infquerry_multiple_hbp"
  if(PLOTFORMAT == "svg"){
    dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "png"){
    dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "pdf"){
    dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } 
}
```


```{r}
par(mfrow=c(1,3))
sim = cpdist(madbn_fit, nodes = c("multipleIAs"), n = 10^4, evidence = (IAlocation_group == "low"))
barplot(prop.table(table(sim)), col = "grey",
        ylim = c(0,0.8),
     main = "P(multipleIAs | IAlocation_group == 'low')")
prop.table(table(sim))

sim = cpdist(madbn_fit, nodes = c("multipleIAs"), n = 10^4, evidence = (IAlocation_group == "medium"))
barplot(prop.table(table(sim)), col = "grey",
     ylim = c(0,0.8), 
     main = "P(multipleIAs | IAlocation_group == 'medium')")
prop.table(table(sim))

sim = cpdist(madbn_fit, nodes = c("multipleIAs"), n = 10^4, evidence = (IAlocation_group == "high"))
barplot(prop.table(table(sim)), col = "grey",
     ylim = c(0,0.8), 
     main = "P(multipleIAs | IAlocation_group == 'high')")
prop.table(table(sim))

if (SAVEPLOTS){
  PLOTNAME <- "infquerry_multiple_location"
  if(PLOTFORMAT == "svg"){
    dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "png"){
    dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "pdf"){
    dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } 
} 
```


```{r}
par(mfrow=c(1,2))
sim = cpdist(madbn_fit, nodes = c("IAlocation_group"), n = 10^4, evidence = (hpt_aware == "yes"))
barplot(prop.table(table(sim)), col = "grey",
        ylim = c(0,0.5), 
     main = "P(IA Location | hpt_aware == 'yes')")
prop.table(table(sim))

sim = cpdist(madbn_fit, nodes = c("IAlocation_group"), n = 10^4, evidence = (hpt_aware == "no"))
barplot(prop.table(table(sim)), col = "grey",
        ylim = c(0,0.5),
     main = "P(IA Location | hpt_aware == 'no')")
prop.table(table(sim))

if (SAVEPLOTS){
  PLOTNAME <- "infquerry_location_hbp"
  if(PLOTFORMAT == "svg"){
    dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "png"){
    dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "pdf"){
    dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } 
}
```
```{r }
par(mfrow = c(1,2))
sim = cpdist(madbn_fit, nodes = c("age_diag_group"), n = 10^4, evidence = (hpt_aware == "yes"))
plot(sim, col = "grey",
     main = "hpt_aware == yes")

sim = cpdist(madbn_fit, nodes = c("age_diag_group"), n = 10^4, evidence = (hpt_aware == "no"))
plot(sim, col = "grey",
     main = "hpt_aware == no")

if (SAVEPLOTS){
  PLOTNAME <- "infquerry_hpt-age"  
  if(PLOTFORMAT == "svg"){
    dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "png"){
    dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "pdf"){
    dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } 
}
```

# Risk estimates relative to reference subpopulation

The aim is a treatment decision support model. 
Therefore the reference population is framed of all those patients (i.e. IA detected), 
that are not treated but followed-up.
Following Bijlenga et al., (Stroke, 2013) these are patients fulfilling the following criteria:
1. No pos. familial history
2. IA size < 4mm & IA at high risk location
or 
2. IA size between 4-7mm & IA at medium risk location
3. IA is not ruptured.

```{r}
plot(cpdist(fitted = madbn_fit_mod, evidence = c((positive_famillial_history == "no" & IAsize_diag_grouped_merged == "A" & IAlocation_group == "high") | (positive_famillial_history == "no" & IAsize_diag_grouped_merged == "A" & IAlocation_group == "medium")), nodes = c("IAruptured")))

prev_ref <- cpquery(fitted = madbn_fit_mod, evidence = c((positive_famillial_history == "no" & IAsize_diag_grouped_merged == "A" & IAlocation_group == "high") | (positive_famillial_history == "no" & IAsize_diag_grouped_merged == "A" & IAlocation_group == "medium")), event = c(IAruptured == "no"))
prev_ref
```

The prevalence of patients fulfilling the above criteria in our study population is 43%.
Most patients present with a ruptured IA at time of diagnosis.

Why?
- Hypothesis: Many unruptured IAs remain undiagnosed as they are frequently asymptomatic.
This could be tested in a cohort study.

The odds of no rupture at diagnosis are therefor smaller than 1, meaning that patients 
have been rather unlikely to present with an unruptured IA in our study population.

```{r}
prev_ref / (1 - prev_ref)
```

## Rupture probability depending on smoking status

```{r }
par(mfrow = c(1,2))
sim = cpdist(madbn_fit_mod, nodes = c("IAruptured"), n = 10^5, evidence = (smoking_current_notcurrent == "current"))
plot(sim, col = "grey",
     main = "smoking_CN == current")

sim = cpdist(madbn_fit_mod, nodes = c("IAruptured"), n = 10^5, evidence = (smoking_current_notcurrent == "not_current"))
plot(sim, col = "grey",
     main = "smoking_CN == not_current")

if (SAVEPLOTS){
  PLOTNAME <- "infquerry_rupture-age-hpt"  
  if(PLOTFORMAT == "svg"){
    dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "png"){
    dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "pdf"){
    dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTWIDTH)
    dev.off()
  } 
}

# P(rupture | smoking == current)
# cpquery(madbn_fit_mod, evidence = c(smoking_current_notcurrent == "current"), event = (IAruptured == "no"))
cpquery(madbn_fit_mod, evidence = c(smoking_current_notcurrent == "current"), event = (IAruptured == "yes"))
# P(rupture | smoking == not_current)
# cpquery(madbn_fit_mod, evidence = c(smoking_current_notcurrent == "not_current"), event = (IAruptured == "no"))
cpquery(madbn_fit_mod, evidence = c(smoking_current_notcurrent == "not_current"), event = (IAruptured == "yes"))
```


```{r}
oddsstatistics <- function(p_event_evidence, p_event_reference){
  #P(event | evidence=e)
  
  # Odds = (event=true | evidence = e) / (event=false | evidence = e)
  odds_event_evidence <- p_event_evidence / (1 - p_event_evidence)
  
  # Odds of event in reference population
  odds_event_reference <- p_event_reference / (1 - p_event_reference)
  
  odds_ratio = odds_event_evidence / odds_event_reference
  
  # CAVE: se and CI are not guaranteed for small values (and we have percentages here...)
  se = sqrt((1/p_event_evidence)+(1/(1-p_event_evidence))+(1/p_event_reference)+(1/(1-p_event_reference)))
  cilower <- exp(log(odds_ratio)-1.96*se)
  ciupper <- exp(log(odds_ratio)+1.96*se)
  
  return(list("odds_event_evidence" = odds_event_evidence, "odds_event_reference" = odds_event_reference, "OR" = odds_ratio, "se"=se, "95%-CI"=c(cilower, ciupper)))
}
oddsstatistics(p_event_evidence = cpquery(fitted = madbn_fit_mod, evidence = c(smoking_current_notcurrent == "current"), event = c(IAruptured == "yes")),
               p_event_reference = cpquery(fitted = madbn_fit_mod, evidence = c((positive_famillial_history == "no" & IAsize_diag_grouped_merged == "A" & IAlocation_group == "high") | (positive_famillial_history == "no" & IAsize_diag_grouped_merged == "A" & IAlocation_group == "medium")), event = c(IAruptured == "no")))
```

The odds of IA rupture are increased in current smokers compared to the reference population.

```{r}
oddsstatistics(p_event_evidence = cpquery(fitted = madbn_fit_mod, evidence = c(smoking_current_notcurrent == "current"), event = c(IAruptured == "yes")),
               p_event_reference = cpquery(fitted = madbn_fit_mod, evidence = c(smoking_current_notcurrent == "not_current"), event = c(IAruptured == "yes")))
```

The odds of IA rupture are increased in current smokers compared to non-smokers.

```{r}
oddsstatistics(p_event_evidence = cpquery(fitted = madbn_fit_mod, evidence = c(gender == "male" & positive_famillial_history == "yes" & age_diag_group == "A" & hpt_aware == "no" & smoking_current_notcurrent == "current"), event = c(IAruptured == "yes")),
               p_event_reference = cpquery(fitted = madbn_fit_mod, evidence = c(smoking_current_notcurrent == "not_current"), event = c(IAruptured == "yes")))
```

Young, smoking males with a pos. fam. history and no HBP awareness are recommended to follow up (OR: 0.96)

```{r}
oddsstatistics(p_event_evidence = cpquery(fitted = madbn_fit_mod, evidence = c(gender == "female" & age_diag_group == "G" & IAlocation_group == "low"), event = c(IAruptured == "yes")),
               p_event_reference = cpquery(fitted = madbn_fit_mod, evidence = c(smoking_current_notcurrent == "not_current"), event = c(IAruptured == "yes")))
```

IAs in low risk locations in older women don't rupture independent of their size (P.B. in Bordeaux).
This is also what the statistics show here.
IAs at low risk location in older women do not rupture (OR: 0.05).


```{r}
str(data)
```

# with restricted size->location

```{r setup}
# Clear working environment
rm(list=ls())

# Load libraries
library(bnaiaR)
library(dplyr)
library(bnlearn)


# Save plots as files? 
SAVEPLOTS <- F
PLOTPATH <- paste0(Sys.getenv("PLOTPATH"), "/fourierplots")
PLOTFORMAT <- "pdf" # "pdf", "svg" or "png"
PLOTWIDTH = 16
PLOTHEIGHT = 9
```

## Load discrete additive mixed-effects BN

```{r message=FALSE, warning=FALSE}
load(paste0(PLOTPATH, "/discrete_BN_SL_additive_bic_mixedeffects_restrictedSizeLoc.RData"))
```


```{r}
data <- tobesaved$madbn_data %>%
  mutate(positive_famillial_history = factor(positive_famillial_history))
bl <- tobesaved$madbn_bl
avg <- tobesaved$madbn_avg
bb <- tobesaved$madbn_boot
```

```{r}
strength.plot(avg,
              bb,
              main = "discrete additive mixed-effects BN",
              # sub = "SL: tabu\nth.=0.3\nScore=BIC",
              shape = "rectangle")
```



## Inference by querying


```{r}
madbn_fit <- bn.fit(data = data, x = avg)
```

```{r}
# remove study_source
avg_mod <- bnlearn::remove.node(avg, "study_source")
bb_mod <-  bb %>%
  filter(from != "study_source") %>%
    filter(to != "study_source")
attr(bb_mod, "nodes") <- attr(bb_mod, "nodes")[-10]
data_mod <- data %>%
  select(-c("study_source"))

strength.plot(avg_mod,
              bb_mod,
              main = "discrete additive mixed-effects BN",
              sub = "Fitting w/o study_source",
              shape = "rectangle")

if (SAVEPLOTS){
  PLOTNAME <- "infquerry_admeBN_fitting_wo_studysource"  
  if(PLOTFORMAT == "svg"){
    dev.print(svg, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "png"){
    dev.print(png, filename = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } else if(PLOTFORMAT == "pdf"){
    dev.print(pdf, file = paste0(PLOTPATH, "/", PLOTNAME, ".", PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    dev.off()
  } 
} 

madbn_fit_mod <- bn.fit(data = data_mod, x = avg_mod)
```
