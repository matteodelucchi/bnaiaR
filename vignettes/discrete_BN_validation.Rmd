---
title: "Model Validation of discrete BN"
author: "Matteo Delucchi"
output:
  rmarkdown::html_document:
    toc: yes
    toc_float:
      collapsed: true
      smooth_scroll: false
    toc_depth: 3
  rmarkdown::html_vignette: default
vignette: >
  %\VignetteIndexEntry{Model Validation of discrete BN}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r development, eval=FALSE, include=FALSE}
# devtools::document()
# devtools::load_all()
# renv::snapshot(prompt = F)
```

```{r setup}
# Clear working environment
rm(list=ls())

# Load libraries
library(bnaiaR)
library(tidyr)
library(dplyr)
library(ggplot2)
library(bnlearn)

# Save plots as files? 
SAVEPLOTS <- F
PLOTPATH <- paste0(Sys.getenv("PLOTPATH"), "/fourierplots")
PLOTFORMAT <- "pdf" # "pdf", "svg" or "png"
PLOTWIDTH = 16
PLOTHEIGHT = 9
```

# Load discrete additive mixed-effects BN


```{r message=FALSE, warning=FALSE}
load(paste0(PLOTPATH, "/discrete_BN_SL_additive_bic_mixedeffects.RData"))
```


```{r}
data <- tobesaved$madbn_data
bl <- tobesaved$madbn_bl
avg <- tobesaved$madbn_avg
bb <- tobesaved$madbn_boot
```

```{r}
strength.plot(avg,
              bb,
              main = "discrete additive mixed-effects BN",
              # sub = "SL: tabu\nth.=0.3\nScore=BIC",
              shape = "rectangle")
```

# Cross-validation for predictive accuracy

## Classification Error of rupture status.

```{r}
xval.rupture <- bn.cv(data = data, 
              bn = avg,
              method = "hold-out",
              runs = 50,
              fit = "mle",
              loss = "pred",
              loss.args = list(target="IAruptured"))

df.cvmetrics <-
  data.frame(
    loocv.dbn.clerr = c(
      avgClassError = mean(loss(xval.rupture)),
      sdClassError = sd(loss(xval.rupture)),
      cv.metrics(xval.rupture, returnConfMat = T)$carret_confmat$overall,
      cv.metrics(xval.rupture, returnConfMat = T)$carret_confmat$byClass
    ))
df.cvmetrics
df.cvmetrics %>%
  mutate(loocv.dbn.clerr = round(loocv.dbn.clerr, digits = 2)) %>%
  tibble::rownames_to_column() %>%
  gt::gt() 
# %>%
  # gt::gtsave(path = PLOTPATH, filename = "classification_error_ruptureStatus_madbn_tbl.html")
```

higher sensitivity as in single centric study
pos. and neg predictive values higher as in single centre study
higher precision, recall and F1 score, prevalence, detection rate, detection prevalence and balanced accuracy

```{r}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "classification_error_ruptureStatus_madbn", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  }
  plot(xval.rupture,
     xlab = c("BIC.signTH"),
     main = "Classification Error of Rupture Status")
  dev.off()
} else {
  plot(xval.rupture.bic.part,
     xlab = c("BIC.signTH"),
     main = "Classification Error of Rupture Status")
}
```


## Averaged, Overall Classification Error of Rupture Status

Average predictive accuracy over all nodes. 

```{r}
xval.list.bic <- list()
for (node in nodes(avg)) {
  xval <- bn.cv(
    data = data,
    bn = avg,
    method = "hold-out",
    runs = 50,
    fit = "mle",
    loss = "pred",
    loss.args = list(target = node)
  )
  xval.list.bic[[node]] <- list(xval = xval, 
                            cv.metrics = cv.metrics(xval))
}


accs.bic <- unlist(lapply(unlist(xval.list.bic, recursive = F), `[[`, "acc"))
summary(accs.bic, na.rm = T)
```


From `?bnlearn::bn.cv()`:  
"...  
Classification Error (pred): the prediction error for a single node in a discrete network. Frequentist predictions are used, so the values of the target node are predicted using only the information present in its local distribution (from its parents). Lower values are better.  

Posterior Classification Error (pred-lw and pred-lw-cg): similar to the above, but predictions are computed from an arbitrary set of nodes using likelihood weighting to obtain Bayesian posterior estimates. pred-lw applies to discrete Bayesian networks, pred-lw-cg to (discrete nodes in) hybrid networks. Lower values are better.  
..."  

## Posterior Classification Error of rupture status

So, we can use a Bayesian predictions that use a random set of available nodes for the prediction.

```{r}
xval.bic.bayes <- bn.cv(data = data, 
              bn = avg,
              method = "hold-out",
              runs = 50,
              fit = "mle",
              loss = "pred-lw",
              loss.args = list(target="IAruptured"))
cv.metrics(xval.bic.bayes)

df.cvmetrics.postclerr <-
  data.frame(
    loocv.dbn.postclerr = c(
      avgPostClassError = mean(loss(xval.bic.bayes)),
      sdClassError = sd(loss(xval.bic.bayes)),
      cv.metrics(xval.bic.bayes, returnConfMat = T)$carret_confmat$overall,
      cv.metrics(xval.bic.bayes, returnConfMat = T)$carret_confmat$byClass
    )
  )
df.cvmetrics.postclerr
df.cvmetrics.postclerr  %>%
  mutate(loocv.dbn.postclerr = round(loocv.dbn.postclerr, digits = 2)) %>%
  tibble::rownames_to_column() %>%
  gt::gt() 
```

Save classification metrics

```{r}
write.csv(df.cvmetrics, file = paste0(PLOTPATH, "/prediction_metrics_madbn.csv"))
```


```{r}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "post_classification_error_ruptureStatus_madbn", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT), res = 300)
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT))
  }
  plot(xval.bic.bayes, 
     xlab = c("BIC"),
     main = "Posterior Classification Error of Rupture Status")
  dev.off()
} else {
  plot(xval.bic.bayes, 
     xlab = c("BIC"),
     main = "Posterior Classification Error of Rupture Status")
}
```
