---
title: "Data Preprocessing: Feature transformation, cleaning, engineering"
author: "Matteo Delucchi"
output:
  rmarkdown::html_document:
    toc: yes
    toc_float:
      collapsed: true
      smooth_scroll: false
    toc_depth: 3
  rmarkdown::html_vignette: default
vignette: >
  %\VignetteIndexEntry{Data Preprocessing: Feature transformation, cleaning, engineering}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r development, eval=FALSE, include=FALSE}
devtools::document()
devtools::load_all()
# renv::snapshot(prompt = F)
```

```{r setup}
# Clear working environment
rm(list=ls())

# Load libraries
library(bnaiaR)
library(tidyr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(RMariaDB)
library(forcats)

# Save plots as files? 
# Warning: Bad layout with knitr. Works well if chunks are run without rendering.
SAVEPLOTS <- FALSE
PLOTPATH <- Sys.getenv("PLOTPATH")
```

# Load Harmonized Raw Data

Copy the data to the current package that was prepared in local, private package.
```{r}
system("cp ../../ExplorDataISGC/ExplorDataISGC/data/adbisgc.rda ../inst/extdata/")
```


```{r}
load(system.file("extdata", "adbisgc.rda", package = "bnaiaR")) 
str(adbisgc, give.attr=F)
```

```{r}
summarytools::dfSummary(adbisgc)
```

# Transform Variables: Merging levels, binarize and logarithms

```{r}
adbisgc_tmp <- adbisgc
```


## Analyse NAs

```{r}
# NA overview: Filter all, with at least one NA in any column.
plt <- adbisgc_tmp %>%
  summarise(across(.cols = everything(), .fns = function(x){is.na(x)})) %>%
  filter(if_any()) %>%
  summarise(across(everything(), sum)) %>%
  
  t() %>%
  as.data.frame() %>%
  mutate(names = rownames(.)) %>%

  ggplot()+
  aes(y=V1, x=names)+
  geom_col() +
  ylab("no. NAs")+
  xlab(element_blank())+
  labs(title = "Missing records in raw data") +
  theme_bw()+
  coord_flip() 

if (SAVEPLOTS) {
  ggsave(
    plot = plt,
    filename = "na_overview_plt.png",
    path = PLOTPATH,
    dpi = 300
  )
} else {
  plt
}
```


## Rename Variables

```{r}
adbisgc_tmp <- adbisgc_tmp %>% 
  rename(hpt_aware = hypertension) %>%
  rename(hpt_treat = hypertension_treatment) %>%
  rename(age_diag = age) %>%
  rename(IAsize_diag = IAsize_at_diag) %>%
  rename(IAsize_diag_grouped = IAsize_at_diag_grouped) %>%
  rename(data_source = source)
str(adbisgc_tmp, give.attr=F)
```

## Merge study sources by country

```{r}
adbisgc_tmp <- adbisgc_tmp %>%
  mutate(study_source = data_source) %>%
  mutate(study_source = stringr::str_replace(study_source, "utrecht_ruptured", "utrecht"),
         study_source = stringr::str_replace(study_source, "geneva_aneuquest", "geneva"),
         study_source = stringr::str_replace(study_source, "geneva_aneux", "geneva")) %>%
  mutate(study_source = as.factor(study_source))
```

## Size groups merged to reduce number of levels

The two classes of large IAs have a small number of observations.
We merge them.

```{r}
adbisgc_tmp <- adbisgc_tmp %>%
  # merge size groups to reduce number of levels
  mutate(IAsize_diag_grouped = as.character(IAsize_diag_grouped)) %>%
  mutate(IAsize_diag_grouped_merged = case_when(IAsize_diag_grouped == "D" ~ "C",
                                                IAsize_diag_grouped == "E" & is.na(IAsize_diag) ~ NA_character_,
                                                          TRUE ~ IAsize_diag_grouped)) %>% 
  mutate(IAsize_diag_grouped = as.factor(IAsize_diag_grouped),
         IAsize_diag_grouped_merged = as.factor(IAsize_diag_grouped_merged)) 
```


```{r}
plt.size.comb <- adbisgc_tmp %>%
  # Plot
  ggplot()+
  aes(x=IAsize_diag_grouped, fill=IAsize_diag_grouped_merged)+
  geom_bar() +
  theme_minimal()+
  labs(title= "Case-distribution of IA size groups",
       y="Number of records",
       x=NULL)+
  scale_fill_manual(values=c("A"=palette.colors(4)[[2]], "B"=palette.colors(4)[[3]], "C"=palette.colors(4)[[4]]),
                    name = "IA size groups merged",
                    labels = LETTERS[1:3])+
  coord_flip()+
  theme(legend.position = c(0.8,0.8),
        legend.background = element_rect(fill = "white", color= "gray"))
plt.size.comb
```

## Large Age groups reduce number of levels

```{r}
plt.age <- adbisgc_tmp %>% 
  # add layouting information
  group_by(age_diag) %>%
  summarise(n = n()) %>%
  mutate(label = case_when(n < 5 ~ n)) %>%
  
  # Plot
  ggplot()+
  aes(x=age_diag, y=n)+
  geom_col(width = 0.5) +
  geom_text(aes(label = label, vjust = -0.2))+
  theme_minimal()+
  labs(title= "Age at time of Diagnosis",
          # caption = stringr::str_wrap("Age at time of diagnosis of IA."),
       y="Number of records",
       x="Age at time of IA diagnosis")+
  theme(plot.caption = element_text(hjust = 0.5),
        plot.caption.position = "plot")

plt.age
```

Age at time of diagnosis is discretized following clinical conventions and
grouped in bins of 5y between the age of 40 and 65.

```{r}
plt.age5y <- adbisgc_tmp %>% 
  # add layouting information
  group_by(age_diag) %>%
  summarise(n = n()) %>%
  mutate(label = case_when(n < 250 ~ n)) %>%
  
  # Plot
  ggplot()+
  aes(x=age_diag, y=n)+
  geom_col() +
  geom_text(aes(label = label, vjust = -0.2))+
  theme_minimal()+
  labs(title= "Case-distribution of grouped Age at time of Diagnosis",
          subtitle = "Grouped in bins of 5y for patients between 40y and 65y.",
          caption = stringr::str_wrap("Age at time of diagnosis of IA grouped in A=[0,40), B=[40,45), C=[45,50), D=[50,55), E=[55,60), F=[60,65), G=[65, max. AgeDiag)"),
       y="Number of records",
       x="Age Group")+
  theme(plot.caption = element_text(hjust = 0.5),
        plot.caption.position = "plot")

if (SAVEPLOTS){
  ggsave(plot = plt.age5y, filename = "age_grouped_5y.png", path = PLOTPATH, dpi = 600)
} else {
  plt.age5y
}
```


To reduce the number of classes of the AgeDiag.grouped variable a coarser 
grouping is included.

```{r}
adbisgc_tmp <- adbisgc_tmp %>%
    mutate(age_diag_group = wrap_age(age_diag))
```


```{r}
plt.age5y <- adbisgc_tmp %>%
  # add layouting information
  group_by(age_diag_group) %>%
  summarise(n = n()) %>%
  mutate(label = case_when(n < 300 ~ n)) %>%
  
  # Plot
  ggplot()+
  aes(x=age_diag_group, y=n)+
  geom_col() +
  geom_text(aes(label = label, vjust = -0.2))+
  theme_minimal()+
  labs(title= "Case-distribution of grouped Age at time of Diagnosis",
          subtitle = "Grouped in bins of 5y for patients between 40y and 65y.",
          caption = stringr::str_wrap("Age at time of diagnosis of IA grouped in A=20-39, B=40-44, C=45-49, D=50-54, E=55-59, F=60-64, G=65-max(age)"),
       y="Number of records",
       x="Age Group")+
  theme(plot.caption = element_text(hjust = 0.5),
        plot.caption.position = "plot")

if (SAVEPLOTS){
  ggsave(plot = plt.age10y, filename = "age_grouped_5y.png", path = PLOTPATH, dpi = 600)
} else {
  plt.age5y
}
```

## Creation of the cohort of patients with lesions in different risk locations

We group IA location by vessel into three classes according their risk of rupture:

```{r}
adbisgc_tmp <- adbisgc_tmp %>%
  mutate(IAlocation_group = harmonize_locbyrisk(IAlocation))

str(adbisgc_tmp, give.attr=F)
```

### Plots


```{r}
plt.locv <- adbisgc_tmp %>%
  # add layouting information
  group_by(IAlocation) %>%
  summarise(n = n()) %>%
  mutate(label = case_when(n < 300 ~ n)) %>%
  
  # Plot
  ggplot()+
  aes(x=IAlocation, y=n)+
  geom_col() +
  geom_text(aes(label = label, hjust = -0.2))+
  theme_minimal()+
  labs(title= "Case-distribution of IA location by vessel",
       y="Number of records",
       x=NULL)+
  theme(plot.caption = element_text(hjust = 0.5),
        plot.caption.position = "plot")+
    coord_flip()

plt.locv
```

```{r}
plt.locr <- adbisgc_tmp %>%
  # Plot
  ggplot()+
  aes(x=IAlocation_group)+
  geom_bar() +
  theme_minimal()+
  labs(title= "Case-distribution of IA location by risk of rupture",
       y="Number of records",
       x=NULL)+
  theme(plot.caption = element_text(hjust = 0.5),
        plot.caption.position = "plot")+
    coord_flip()

plt.locr
```

```{r}
plt.loc.comb <- adbisgc_tmp %>%
  select(c(IAlocation, IAlocation_group)) %>%
  
  # Plot
  ggplot()+
  aes(x=IAlocation, fill=IAlocation_group)+
  geom_bar() +
  theme_minimal()+
  labs(title= "Case-distribution of IA location",
       y="Number of records",
       x=NULL)+
  scale_fill_manual(values=c("high" = "darkred", "medium"= "darkorange", "low"="darkgreen"), name = "Risk of IA rupture")+
  theme(plot.caption = element_text(hjust = 0.5),
        plot.caption.position = "plot")+
  coord_flip()

if (SAVEPLOTS) {
  ggsave(
    plot = plt.loc.comb,
    filename = "location_multiplot.png",
    path = PLOTPATH,
    dpi = 600
  )
} else {
  plt.loc.comb
}
```



## Size logarithmic fits gaussian distribution


```{r}
adbisgc_tmp <- adbisgc_tmp %>%
  # add logarithm of size
  mutate(IAsize_diag_log = log(round(IAsize_diag, 2)))

str(adbisgc_tmp, give.attr=F)
```


IAsize outliers

```{r}
plt.size.log <- ggplot(adbisgc_tmp, aes(x= IAsize_diag_log)) +
      geom_bar(stat = "count", show.legend = TRUE, col="black", fill="gray") +
      geom_text(aes(label=ifelse((stat(count)<10) & (x>4), stat(count),"")), stat='count', nudge_y=20)+
      theme_minimal()+
  labs(title= "Case-distribution of log(IAsize)",
          caption = stringr::str_wrap("Histogram of log(IAsize) with large values (log(IAsize)>4) labeled with their number of records."),
       y="Number of records",
       x="log(IAsize)")+
  theme(plot.caption = element_text(hjust = 0.5),
        plot.caption.position = "plot")

if (SAVEPLOTS){
  ggsave(plot = plt.size.log, filename = "IAsize_log_outliers.png", path = PLOTPATH,
         width =9, height = 7, dpi = 600)
} else {
  plt.size.log
}
```

Multiplot IA size

```{r}
# IA size cont.
plt.size <- adbisgc_tmp %>%
  filter(IAsize_diag >= 0) %>%
  
  ggplot(aes(x= IAsize_diag)) +
      geom_bar(stat = "count", show.legend = TRUE, col="black", fill="gray") +
      # geom_text(aes(label=ifelse((stat(count)<10) & (x>4), stat(count),"")), stat='count', nudge_y=20)+
      theme_minimal()+
  scale_x_continuous(breaks = c(seq(0, max(adbisgc_tmp$IAsize_diag, na.rm = T), 20)),
                     minor_breaks = seq(0, max(adbisgc_tmp$IAsize_diag, na.rm = T), 50))+
  labs(title= "Case-distribution of IA size",
          # caption = stringr::str_wrap("Histogram of IA size with large values (IAsize>50) labeled with their number of records."),
       y="Number of records",
       x="max. Diameter [mm]")+
  theme(plot.caption = element_text(hjust = 0.5),
        plot.caption.position = "plot")

# IA size log.
plt.size.log <- plt.size.log+
  theme(plot.caption = element_blank(),
        plot.caption.position = "plot",
    panel.background = element_rect(fill = "transparent", color = NA),
    plot.background = element_rect(fill = "transparent", colour = NA))

# IA size grouped
plt.size.comb <- plt.size.comb +
  theme(plot.caption = element_blank(),
        plot.caption.position = "plot",
    panel.background = element_rect(fill = "transparent", color = NA),
    plot.background = element_rect(fill = "transparent", colour = NA))

plt.comb.size <- cowplot::plot_grid(plt.size, plt.size.log, plt.size.comb, labels = "AUTO", ncol = 1)+
  theme(plot.caption = element_blank(),
        plot.caption.position = "plot",
    panel.background = element_rect(fill = "transparent", color = NA),
    plot.background = element_rect(fill = "transparent", colour = NA))

if (SAVEPLOTS){
  ggsave(plot = plt.comb.size, filename = "size_multiplot.png", path = PLOTPATH, 
         dpi = 600, height = 13, bg = "transparent")
} else {
  plt.comb.size
}

```

# Filter

```{r}
summarytools::label(adbisgc_tmp$age_diag_group) <- "age_diag grouped in A=20-39, B=40-44, C=45-49, D=50-54, E=55-59, F=60-64, G=65-93 years."
summarytools::label(adbisgc_tmp$IAlocation_group) <- "IA location grouped into their respective rupture risk levels. For details see '?harmonize_locbyrisk'"
summarytools::label(adbisgc_tmp$IAsize_diag_grouped) <- "IA size group A ≤ 7mm, B = 8 − 12mm, C 13 - 25mm, D ≥ 25mm, E == NA."
summarytools::label(adbisgc_tmp$IAsize_diag_grouped_merged) <- "IA size groups C and D merged and E encoded as NA."
summarytools::label(adbisgc_tmp$IAsize_diag_grouped_merged) <- "IA size groups C and D merged and E encoded as NA."

adbisgc_tmp %>%
  # sort variables alphabetically
  select(sort(tidyselect::peek_vars())) %T>%
  
  str(give.attr = F) %>%
  summarytools::dfSummary(max.distinct.values = 20)
```


```{r}
adbisgc_tmp <- adbisgc_tmp %>%
  pipe_message("filter age outliers.") %>%
  filter((age_diag >= 10)&(age_diag <=100)) %>%
  pipe_message("filter IA size outliers.") %>%
  filter((IAsize_diag_log>0)&(IAsize_diag_log<4)) 

adbisgc_tmp %>%
  # sort variables alphabetically
  select(sort(tidyselect::peek_vars())) %T>%
  
  str(give.attr = F) %>%
  summarytools::dfSummary(max.distinct.values = 20)
```


# one-hot-encoding

```{r}
adbisgc_tmp_ohe <- adbisgc_tmp %>%
  select(-c(ID_1, ID_2)) %>%
  data.table::as.data.table() %>%
 
  mltools::one_hot(dropCols = T,
                   sparsifyNAs = T)
str(adbisgc_tmp_ohe)
```

## Save ADB as .rds 

```{r save adb}
adbisgc <-adbisgc_tmp
adbisgc_ohe <- adbisgc_tmp_ohe

summary_adbisgc <- summarytools::dfSummary(adbisgc, max.distinct.values = 20)
summary_adbisgc_ohe <- summarytools::dfSummary(adbisgc_ohe, max.distinct.values = 20)

summarytools::view(summary_adbisgc, method = "browser", file = paste0(PLOTPATH, "/dfsummary_adbisgc.html"))
summarytools::view(summary_adbisgc_ohe, method = "browser", file = paste0(PLOTPATH, "/dfsummary_adbisgc_ohe.html"))

saveRDS(adbisgc,
        file = "/home/delt/ZHAW/ExplorDataISGC/2207_adbisgc_data/2207_adbisgc.rds")
write.csv(adbisgc, 
          file = "/home/delt/ZHAW/ExplorDataISGC/2207_adbisgc_data/2207_adbisgc.csv")
saveRDS(adbisgc_ohe,
        file = "/home/delt/ZHAW/ExplorDataISGC/2207_adbisgc_data/2207_adbisgc_ohe.rds")
write.csv(adbisgc_ohe, 
          file = "/home/delt/ZHAW/ExplorDataISGC/2207_adbisgc_data/2207_adbisgc_ohe.csv")
```

# Include Preprocessed Data in bnaiaR package

```{r}
# usethis::use_data(adbisgc, overwrite = TRUE)
# usethis::use_data(adbisgc_ohe, overwrite = TRUE)
# devtools::document()
```
