---
title: "Structure Learning of discrete BN"
author: "Matteo Delucchi"
output:
  rmarkdown::html_document:
    toc: yes
    toc_float:
      collapsed: true
      smooth_scroll: false
    toc_depth: 3
  rmarkdown::html_vignette: default
vignette: >
  %\VignetteIndexEntry{Structure Learning of discrete BN}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r development, eval=FALSE, include=FALSE}
# devtools::document()
# devtools::load_all()
# renv::snapshot(prompt = F)
```


```{r setup}
# Clear working environment
rm(list=ls())

library(bnaiaR)
library(dplyr)
library(ggplot2)
library(bnlearn)
library(doParallel)

set.seed(100)

SAVEPLOTS <- T
PLOTPATH <- Sys.getenv("PLOTPATH")
PLOTFORMAT <- "pdf" # "svg", "png"
PLOTWIDTH = 16
PLOTHEIGHT = 9
```

# Structure Learning of discrete BN


```{r}
data("exp1_dat")
data.dbn <- exp1_dat$abndata
dist.dbn <- exp1_dat$dist
banned.dbn <- exp1_dat$banned
bl.dbn <- exp1_dat$bl

str(data.dbn)
print(bl.dbn)
```

Nothing can point to study source.
```{r}
bl.dbn <- bl.dbn[-which(bl.dbn$From=="study_source"),]
bl.dbn <- bl.dbn[-which(bl.dbn$To=="study_source"),]

bl.dbn <- rbind(bl.dbn, data.frame("From" = names(data.dbn), "To" = rep("study_source", length(names(data.dbn)))))
bl.dbn <- bl.dbn[-which(bl.dbn$From=="study_source" & bl.dbn$To=="study_source"),]
bl.dbn
```


```{r learn_with_aic, warning=FALSE}
cl = makeCluster(6)

bb = boot.strength(data.dbn, 
                   algorithm = "tabu", 
                   R = 500,
                   cluster = cl, 
                   algorithm.args = list(score = "aic", 
                                         blacklist = bl.dbn,
                                         tabu = 50))
avg = averaged.network(bb)
```


```{r, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_aic", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(1,2))
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
  dev.off()
} else {
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
}
```

We can of course increase the threshold a bit to prune borderline arcs and paper
over the shortcomings of AIC.

```{r learn_with_aic_and_threshold, warning=FALSE}
avg = averaged.network(bb, threshold = 0.6)

if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_aic_redTH", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  strength.plot(avg, bb, shape = "rectangle")
} else {
  strength.plot(avg, bb, shape = "rectangle")
}
```




```{r learn_with_bic, warning=FALSE}
bb = boot.strength(data.dbn, 
                   algorithm = "tabu", 
                   R = 500,
                   cluster = cl, 
                   algorithm.args = list(score = "bic", 
                                         blacklist = bl.dbn,
                                         tabu = 50))
avg = averaged.network(bb)
```

```{r, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_bic", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(1,2))
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
  dev.off()
} else {
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
}
```

```{r, warning=FALSE}
avg = averaged.network(bb, threshold = 0.3)

if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_bic_redTH", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  strength.plot(avg, bb, shape = "rectangle")
} else {
  strength.plot(avg, bb, shape = "rectangle")
}
```

```{r}
parallel::stopCluster(cl)
```

# Structure Learning of discrete BN w/o study_source


```{r}
data("exp1_dat")
data.dbn.nostudy <- exp1_dat$abndata %>%
  select(-c(study_source)) %>%
  filter(positive_famillial_history != "probably")
bl.dbn.nostudy <- exp1_dat$bl %>%
  filter(From != "study_source" & To != "study_source")

str(data.dbn.nostudy)
print(bl.dbn.nostudy)
```

```{r learn_with_aic, warning=FALSE}
cl = makeCluster(6)

bb = boot.strength(data.dbn.nostudy, 
                   algorithm = "tabu", 
                   R = 500,
                   cluster = cl, 
                   algorithm.args = list(score = "aic", 
                                         blacklist = bl.dbn.nostudy,
                                         tabu = 50))
avg = averaged.network(bb)
```

```{r, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_nostudysource_aic", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(1,2))
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
  dev.off()
} else {
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
}
```

```{r, warning=FALSE}
avg = averaged.network(bb, threshold = 0.3)

if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_nostudysource_aic_redTH", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  strength.plot(avg, bb, shape = "rectangle")
} else {
  strength.plot(avg, bb, shape = "rectangle")
}
```



```{r learn_with_bic, warning=FALSE}
bb = boot.strength(data.dbn.nostudy, 
                   algorithm = "tabu", 
                   R = 500,
                   cluster = cl, 
                   algorithm.args = list(score = "bic", 
                                         blacklist = bl.dbn.nostudy,
                                         tabu = 50))
avg = averaged.network(bb)
```

```{r, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_nostudysource_bic", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(1,2))
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
  dev.off()
} else {
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
}
```

```{r, warning=FALSE}
avg = averaged.network(bb, threshold = 0.2)

if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_nostudysource_bic_redTH", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  strength.plot(avg, bb, shape = "rectangle")
} else {
  strength.plot(avg, bb, shape = "rectangle")
}
```

```{r}
parallel::stopCluster(cl)
```


# Structure Learning of discrete BN w/o study_source for each source individually


```{r}
data("exp1_dat")
data.dbn <- exp1_dat$abndata  %>%
  filter(positive_famillial_history != "probably")
bl.dbn.nostudy <- exp1_dat$bl %>%
  filter(From != "study_source" & To != "study_source")

str(data.dbn)
print(bl.dbn.nostudy)
```


```{r learn_with_aic, warning=FALSE}
cl = parallel::makeCluster(4)
bb_studies_aic <- list()
bb_studies_bic <- list()

for (study in unique(data.dbn$study_source)){
  message(paste("Working on study centre: ", study))

  
  # Filter data set for current study only
  data.dbn.partial <- data.dbn %>%
    filter(study_source == study) %>%
    select(-c(study_source))
  
  # learn BN
  message("\twith tabu and AIC...")
  bb_studies_aic[[study]] = boot.strength(data.dbn.partial, 
                                      algorithm = "tabu", 
                                      R = 500,
                                      cluster = cl,
                                      algorithm.args = list(score = "aic", 
                                                            blacklist = bl.dbn.nostudy,
                                                            tabu = 50))
  
  message("\twith tabu and BIC...")
  bb_studies_bic[[study]] = boot.strength(data.dbn.partial, 
                                      algorithm = "tabu", 
                                      R = 500,
                                      cluster = cl,
                                      algorithm.args = list(score = "bic", 
                                                            blacklist = bl.dbn.nostudy,
                                                            tabu = 50))
}
parallel::stopCluster(cl)

# Collect all BNs in one list of scores : studies : BNs
bb_studies <- list("aic" = bb_studies_aic, "bic" = bb_studies_bic)
```


```{r learn_with_aic, warning=FALSE}
avg_studies = list()
# print all AIC BNs
for (score in names(bb_studies)){
  for(study in names(bb_studies[[score]])){
    bb <- bb_studies[[score]][[study]]
    avg = averaged.network(bb, threshold = 0.2)
    avg_studies[[score]][[study]] <- avg
    
    if (SAVEPLOTS) {
    FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_per_studysource_", score, "_", study, ".")
    if (PLOTFORMAT == "svg") {
      svg(paste0(FILE, PLOTFORMAT))
    } else if (PLOTFORMAT == "png") {
      png(paste0(FILE, PLOTFORMAT))
    } else if (PLOTFORMAT == "pdf") {
      pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    }
    par(mfrow=c(1,2))
    strength.plot(avg, bb, shape = "rectangle", main = paste(score, study))
    plot(bb, main = paste(score, study))
    dev.off()
  } else {
    strength.plot(avg, bb, shape = "rectangle", main = paste(score, study))
    plot(bb, main = paste(score, study))
  }
  }
}
```

```{r compare_plot_aic, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_per_studysource_aic_compareplt", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(3,2))
  graphviz.compare(avg_studies[[1]][[1]], 
                 avg_studies[[1]][[2]], 
                 avg_studies[[1]][[3]], 
                 avg_studies[[1]][[4]], 
                 avg_studies[[1]][[5]], 
                 main = c(paste(names(avg_studies)[1], names(avg_studies[[1]])[1]),
                          paste(names(avg_studies)[1], names(avg_studies[[1]])[2]),
                          paste(names(avg_studies)[1], names(avg_studies[[1]])[3]),
                          paste(names(avg_studies)[1], names(avg_studies[[1]])[4]),
                          paste(names(avg_studies)[1], names(avg_studies[[1]])[5])), 
                 diff = "none", 
                 shape = "rectangle")
dev.off()
} else {
  graphviz.compare(avg_studies[[2]][[1]], 
                 avg_studies[[2]][[2]], 
                 avg_studies[[2]][[3]], 
                 avg_studies[[2]][[4]], 
                 avg_studies[[2]][[5]], 
                 main = c(paste(names(avg_studies)[2], names(avg_studies[[2]])[1]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[2]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[3]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[4]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[5])), 
                 diff = "none", 
                 shape = "rectangle")
}
```


```{r compare_plot_bic, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_per_studysource_bic_compareplt", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(3,2))
  graphviz.compare(avg_studies[[2]][[1]], 
                 avg_studies[[2]][[2]], 
                 avg_studies[[2]][[3]], 
                 avg_studies[[2]][[4]], 
                 avg_studies[[2]][[5]], 
                 main = c(paste(names(avg_studies)[2], names(avg_studies[[2]])[1]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[2]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[3]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[4]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[5])), 
                 diff = "none", 
                 shape = "rectangle")
  dev.off()
} else {
  graphviz.compare(avg_studies[[2]][[1]], 
                 avg_studies[[2]][[2]], 
                 avg_studies[[2]][[3]], 
                 avg_studies[[2]][[4]], 
                 avg_studies[[2]][[5]], 
                 main = c(paste(names(avg_studies)[2], names(avg_studies[[2]])[1]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[2]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[3]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[4]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[5])), 
                 diff = "none", 
                 shape = "rectangle")
}
```


# Structure Learning of discrete BN with study source as parent of everything

```{r}
data("exp1_dat")
data.dbn.allstudy <- exp1_dat$abndata %>%
  filter(positive_famillial_history != "probably")
bl.dbn.allstudy <- exp1_dat$bl %>%
  filter(From != "study_source" & To != "study_source") 

wl.dbn.allstudy <- data.frame("From" = rep("study_source", length(names(data.dbn.allstudy))), "To" = names(data.dbn.allstudy)) %>%
  filter(To != "study_source") # Study source can not influence itself

str(data.dbn.allstudy)
print(bl.dbn.allstudy)
print(wl.dbn.allstudy)
```


```{r learn_with_aic, warning=FALSE}
cl = makeCluster(6)

bb = boot.strength(data.dbn.allstudy, 
                   algorithm = "tabu", 
                   R = 500,
                   cluster = cl, 
                   algorithm.args = list(score = "aic", 
                                         blacklist = bl.dbn.allstudy,
                                         whitelist = wl.dbn.allstudy,
                                         tabu = 50))
avg = averaged.network(bb)
```

```{r, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_studysourceASparent_aic", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(1,2))
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
  dev.off()
} else {
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
}
```

```{r, warning=FALSE}
avg = averaged.network(bb, threshold = 0.3)

if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_studysourceASparent_aic_redTH", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  strength.plot(avg, bb, shape = "rectangle")
} else {
  strength.plot(avg, bb, shape = "rectangle")
}
```




```{r learn_with_bic, warning=FALSE}
bb = boot.strength(data.dbn.allstudy, 
                   algorithm = "tabu", 
                   R = 500,
                   cluster = cl, 
                   algorithm.args = list(score = "bic", 
                                         blacklist = bl.dbn.allstudy,
                                         whitelist = wl.dbn.allstudy,
                                         tabu = 50))
avg = averaged.network(bb)
```

```{r, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_studysourceASparent_bic", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(1,2))
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
  dev.off()
} else {
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
}
```

```{r}
parallel::stopCluster(cl)
```

# additive discrete BN

```{r}
data("exp1_dat")
data.dbn.nostudy <- exp1_dat$abndata %>%
  select(-c(study_source)) 
  # filter(positive_famillial_history != "probably")
bl.dbn.nostudy <- exp1_dat$bl %>%
  filter(From != "study_source" & To != "study_source")

dist.dbn.nostudy <- exp1_dat$dist

str(data.dbn.nostudy)
print(bl.dbn.nostudy)
print(dist.dbn.nostudy)
```

```{r just to test should be same as above}
wtable = function(x, y, w) {
   # normalize the weights to sum up to the sample size.
   w = w / sum(w) * length(w)
   # tally the weights.
   if (missing(y))
     tab = tapply(w, list(x), sum)
   else
     tab = tapply(w, list(x, y), sum)
   # unobserved combinations of values are tabulated as zeros.
   tab[is.na(tab)] = 0
   return(as.table(tab))
}#WTABLE

weighted.bic = function(node, parents, data, args) {
   n = nrow(data)
   w = args$weights
   if (length(parents) == 0) {
     counts = wtable(data[, node], w = w)
     nparams = dim(counts) - 1
     sum(counts * log(counts / n)) - nparams * log(n) / 2
   }#THEN
   else {
     counts = wtable(data[, node], configs(data[, parents, drop = FALSE]), w = w)
     nparams = ncol(counts) * (nrow(counts) - 1)
     sum(counts * log(prop.table(counts, 2))) - nparams * log(n) / 2
   }#ELSE

}#WEIGHTED.BIC

bb = boot.strength(data.dbn.nostudy, 
                   algorithm = "tabu", 
                   R = 500,
                   # cluster = cl, 
                   algorithm.args = list(score = "custom",
                                         fun = weighted.bic,
                                         blacklist = bl.dbn.nostudy,
                                         args = list(weights = rep(1, nrow(data.dbn.nostudy))),
                                         # whitelist = wl.dbn.allstudy,
                                         tabu = 50))
avg = averaged.network(bb)
strength.plot(avg, bb, shape = "rectangle")
plot(bb)
```


```{r additive discrete BN w/o mixed effects}
cl = makeCluster(6)

glm.bic = function(node, parents, data, args) {
  dist = args$dist
  
  if (length(parents) == 0)
    model = as.formula(paste(node, "~ 1"))
  else
    model = as.formula(paste(node, "~", paste(parents, collapse = "+")))
  
  if (dist[[node]] == "gaussian")
     - BIC(glm(model, data = data, family = "gaussian")) / 2
   else if (dist[[node]] == "binomial")
     - BIC(glm(model, data = data, family = "binomial")) / 2
  else if (dist[[node]] == "multinomial") 
    # - BIC(glm(model, data = data, family = dist[[node]])) / 2
    -BIC(nnet::multinom(formula = model, data = data)) / 2
 }#GLM.BIC

bb = boot.strength(data.dbn.nostudy, 
                   algorithm = "tabu", 
                   R = 500,
                   cluster = cl,
                   algorithm.args = list(score = "custom",
                                         fun = glm.bic,
                                         blacklist = bl.dbn.nostudy,
                                         # whitelist = wl.dbn.allstudy,
                                         args = list(dist = dist.dbn.nostudy),
                                         tabu = 50))
avg = averaged.network(bb)
```

```{r, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_additive_bic", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(1,2))
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
  dev.off()
} else {
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
}
```

```{r}
parallel::stopCluster(cl)
```

# additive discrete BN with study source as mixed effect


```{r}
data("exp1_dat")
data.dbn.additive <- exp1_dat$abndata 
  # select(-c(study_source))
  # filter(positive_famillial_history != "probably")
bl.dbn.additive <- exp1_dat$bl %>%
  filter((From != "study_source") & (To != "study_source") ) 
  # study_source doesn't connect with anything. Basically ignore it in SL but keep 
  # it as mixed-effect
  # rbind(., data.frame(From = rep("study_source", length(names(data.dbn.additive))), To = names(data.dbn.additive))) %>%
  # rbind(., data.frame(From = names(data.dbn.additive), To = rep("study_source", length(names(data.dbn.additive))))) 

dist.dbn.additive <- exp1_dat$dist

str(data.dbn.additive)
print(bl.dbn.additive)
print(dist.dbn.additive)
```

```{r}
# cl = makeCluster(6)
cl = makeCluster(6, outfile = path.expand(paste0(getwd(), "/glmm.bic.out")))
```

```{r first draft additive discrete BN w/ mixed effects}
# glm.bic = function(node, parents, data, args) {
#   dist = args$dist
#   mixed_effect = args$mixed_effect
#   
#   if (length(parents) == 0)
#     # no parent no random effect
#     model = as.formula(paste(node, "~ 1"))
#     # model = as.formula(paste(node, "~ 1 + (0|", mixed_effect ,")"))
#     # model = as.formula(paste(node, "~ (1|", mixed_effect ,")"))
#   else
#     model = as.formula(paste(node, "~ (1|", mixed_effect ,")+", paste(parents, collapse = "+")))
#   
#   print(model)
#   # browser()
#   
#   if (dist[[node]] == "gaussian")
#     - BIC(lme4::glmer(model, data = data, family = "gaussian")) / 2
#   
#   # else if (dist[[node]] == "binomial")
#   #   - BIC(lme4::glmer(model, data = data, family = "binomial")) / 2 # Error: No random effect specified
#   else if (dist[[node]] == "binomial" & length(parents) == 0)
#     - BIC(glm(model, data = data, family = "binomial")) / 2
#   else if (dist[[node]] == "binomial" & length(parents) > 0)
#     - BIC(lme4::glmer(model, data = data, family = "binomial")) / 2
#   
#   # else if (dist[[node]] == "multinomial")
#     # -BIC(mclogit::mblogit(formula = model, data = data)) / 2
#     # -BIC(nnet::multinom(formula = model, data = data)) / 2
#   else if ((dist[[node]] == "multinomial") && (length(parents) == 0))
#     -BIC(mclogit::mblogit(formula = model, data = data)) / 2
#     # - BIC(glm(model, data = data, family = dist[[node]])) / 2
#     # -BIC(nnet::multinom(formula = model, data = data)) / 2
#   else if ((dist[[node]] == "multinomial") & (length(parents) > 0)){
#     model_basic = as.formula(paste(node, "~ ", paste(parents, collapse = "+")))
#     model_random = as.formula(paste("~ 1|", mixed_effect, sep = ""))
#     mod_mblogit = mclogit::mblogit(formula = model_basic, random = model_random, data = data)
#     -BIC(mod_mblogit) / 2}
#   # -BIC(nnet::multinom(formula = model, data = data)) / 2
#  }#GLM.BIC
# 
# bb = boot.strength(data.dbn.additive, 
#                    algorithm = "tabu", 
#                    R = 5,
#                    # cluster = cl,
#                    algorithm.args = list(score = "custom",
#                                          fun = glm.bic,
#                                          blacklist = bl.dbn.additive,
#                                          # whitelist = wl.dbn.allstudy,
#                                          args = list(dist = dist.dbn.additive,
#                                                      mixed_effect = "study_source"),
#                                          tabu = 50))
# avg = averaged.network(bb)
# strength.plot(avg, bb, shape = "rectangle")
# plot(bb)
```

```{r additive discrete BN w/ mixed effects}
glmm.bic = function(node, parents, data, args) {
  dist = args$dist
  mixed_effect = args$mixed_effect
  
  if (length(parents) == 0)
    # no parent no random effect
    model = as.formula(paste(node, "~ 1"))
  else
    model = as.formula(paste(node, "~ (1|", mixed_effect ,")+", paste(parents, collapse = "+")))
  
  message(deparse1(model))

  if (dist[[node]] == "gaussian")
    - BIC(lme4::glmer(model, data = data, family = "gaussian")) / 2
  
  else if (dist[[node]] == "binomial" & length(parents) == 0)
    - BIC(glm(model, data = data, family = "binomial")) / 2
  else if (dist[[node]] == "binomial" & length(parents) > 0)
    - BIC(lme4::glmer(model, data = data, family = "binomial")) / 2
  
  else if ((dist[[node]] == "multinomial") && (length(parents) == 0))
    -BIC(mclogit::mblogit(formula = model, data = data)) / 2
  else if ((dist[[node]] == "multinomial") & (length(parents) > 0)){
    model_basic = as.formula(paste(node, "~ ", paste(parents, collapse = "+")))
    model_random = as.formula(paste("~ 1|", mixed_effect, sep = ""))
    message(paste("using mblogit with fixed term:", deparse1(model_basic), "and random term:", deparse1(model_random)))
    
    mod_mblogit = mclogit::mblogit(formula = model_basic, random = model_random, data = data)
    -BIC(mod_mblogit) / 2}
 }#GLMM.BIC
```


```{r additive discrete BN w/ mixed effects}
stime <- Sys.time()

bb = boot.strength(data.dbn.additive, 
                   algorithm = "tabu", 
                   R = 5,
                   cluster = cl,
                   algorithm.args = list(score = "custom",
                                         fun = glmm.bic,
                                         blacklist = bl.dbn.additive,
                                         # whitelist = wl.dbn.allstudy,
                                         args = list(dist = dist.dbn.additive,
                                                     mixed_effect = "study_source"),
                                         tabu = 50))
etime <- Sys.time()
running_time <- etime-stime
print(paste("Running time: ", running_time))

avg = averaged.network(bb)
strength.plot(avg, bb, shape = "rectangle")
plot(bb)
```

Thoughts:
Ideally, study_source is not present as node. But it can't be removed as it must
be present as random effect. It can not either be completely blacklisted as this
would cause it being removed from the data set in the backend.

IDEA: restrict all arcs to source and (since we can't restrict all arcs from source)
multiply score to make it very "bad" if study_source among covariates. 










```{r}
parallel::stopCluster(cl)
```
































# Bootstrap size optimization

We estimate the size of the non-parametric bootstrap replicate stepwise to 
investigate on the the model performance and number of bootstrap replicates.

Since it is an open question to compare an estimated model to the true unknown model
(see [(Thesis of Scutari 2011)](https://www.bnlearn.com/about/thesis/thesis.pdf)), 
we try different measures.

I don't go into detail about all the applied measures at this point. Please 
look in the help page of the functions in `structureanalysis.R` for more details.

```{r bootstrap eval, echo=FALSE, message=FALSE, warning=FALSE}
cl = makeCluster(6)

eval <- NULL

for (b in c(100,seq(500, 10000, 1000))) {
  print("--------------------------------------------------------------------------------")
  tabusize = 18
  crt = "bic" # BIC standard
  priorname = "uniform" # uniform standard
  algo = "tabu"
  print(paste("Bootstrap replicates: ", b))

  boot.tabu <- boot.strength(data = data,
                      R = b,
                        algorithm = algo,
                        algorithm.args = list(
                          tabu = tabusize,
                          blacklist = bl,
                          score = crt,
                          prior = priorname),     # prior distribution to be used with the various Bayesian Dirichlet scores
                        cluster = cl)

  avg.boot.tabu <- averaged.network(boot.tabu)
  avg.boot.tabu.th0 <- averaged.network(boot.tabu, threshold = 0)


  netmet <- network.metrics(data, avg.boot.tabu, avg.boot.tabu.th0, algo=algo, tabulistsize=tabusize, b=b, trueGraph=ekg, crt=crt, priorname=priorname)

  if (!is.null(eval)){
    eval <- rbind(eval, netmet)
  } else{
    eval <- netmet
    }
  }
stopCluster(cl)

eval.bootstrap.rep.tabu <- eval

eval.bootstrap.rep.tabu.plot.data <- eval.bootstrap.rep.tabu %>%
  prep.data2plot() %>%
  select(-c(tabu.list.size, Algorithm)) %>%
  data.table::melt(id.vars = c("bootstrap.replicates", "score.function", "prior")) %>%
  mutate(across(5, function(x){round(as.numeric(x),3)})) %>%

  # rearrange order (of bootstrap.replicates) for grouped display (by prior) in graph
  mutate(bootstrap.replicates = as.integer(bootstrap.replicates)) %>%
  arrange(desc(bootstrap.replicates), .group_by = TRUE) %>%

  ggplot() +
  aes(x = bootstrap.replicates, y = value, group = score.function, color = prior)+
  geom_point() +
  # geom_text(aes(label=round(value,2)), hjust=0, vjust=2, angle = -45)+
  geom_line()+
  facet_grid(c("variable"), scales = "free_y")+
  # facet_wrap(~variable, scales = "free_y") +
  # scale_x_continuous(breaks = c(100,500,1000,5000))+
  theme_minimal()+
  scale_color_discrete(name = "Prior",
                       labels = c("Uniform"))+
#   scale_y_continuous(breaks = function(x, n = 5) {
#     # Show only integers on y-axis
#     l <- pretty(x, n)
#     ifelse(!all(l > 0),
#       return(l[abs(l %% 1) < .Machine$double.eps ^ 0.5]),
#       return(l))
#     })+
  ggtitle(c("Structure Learning Metrics"),
        subtitle = paste("Varying Bootstrap Replicas.\nSL Algorithm: ", algo,"\nTabulist size: ", tabusize, "\nScore:", crt)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text.y = element_text(angle = 0, hjust = 0),
        panel.background = element_rect(),
        panel.spacing = unit(1, "lines"))
```


```{r classic bootstrap plot, warning=FALSE, out.height=2400, out.width="80%"}
plt <- eval.bootstrap.rep.tabu.plot.data +
  theme(panel.spacing = unit(0.3, "lines"))

if (SAVEPLOTS){
  ggsave(plot = plt, filename = "bootstrap_size_eval.png", path = PLOTPATH,
         width =9, height = 15, dpi = 600)
} else {
  plt
}
```


The network score is the typical goodness of fit measure of such a model. 
We do not detect a clear relationship. Therefore, and because of still reasonable
computation time, we just assume a large number of bootstrap replicates.

# Structure learning algorithm assessment

Analogous to the non-parametric bootstrap size estimate above, it would be 
interesting to measure the model performance resulting from a set of different
structure learning algorithms.  

The open issue of measuring the goodness of fit of a model stays the same as 
when optimizing the number bootstrap replicas: it's very difficult to measure and 
in practice the network score (mostly BIC) is used to compare model performance.

The results are therefore omitted at this point.

# Structure Learning with TABU search and BIC

For aforementioned reasons, we focus on recent but standard methodologies 
and parameters.

The final DAG is the averaged structural model resulting from repetitively applying
the structure learning algorithm TABU on a non-parametric bootstrap sample. 

```{r bootstrap data, echo=FALSE, message=FALSE, warning=FALSE}
cl = makeCluster(6)

# Structure learning with non-parametric bootstrap framework
cl = makeCluster(6)
algo = "tabu"
b = 10000
tabusize = 18
crt = "bic" # BIC standard
priorname = "uniform" # uniform standard
boot <- boot.strength(
  data = data,
  R = b,
  algorithm = algo,
  algorithm.args = list(
    tabu = tabusize,
    blacklist = bl,
    score = crt,
    prior = priorname
  ),
  # prior distribution to be used with the various Bayesian Dirichlet scores
  cluster = cl
)
stopCluster(cl)

arcstren[[algo]] <- boot

avg.boot <- averaged.network(boot)
avgnet[[algo]] <- avg.boot

avg.boot.th0 <- averaged.network(boot, threshold = 0)
avgnet.th0[[algo]] <- avg.boot.th0

netmet <- network.metrics(
  data,
  estGraph = avg.boot,
  estGraph.th0 = avg.boot.th0,
  algo = algo,
  tabulistsize = ifelse(algo == "tabu", tabusize, NA),
  b = b,
  trueGraph = ekg,
  crt = crt,
  priorname = priorname
)
```


```{r}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "arcstren_tabu_bic", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT))
  }
  plot(arcstren[["tabu"]])
  # abline(v=0.3)
  dev.off()
} else {
  plot(arcstren[["tabu"]])
  abline(v = 0.3)
}
```


We see many arcs of low support and no visually clear cut-point to set the arc-strength
threshold. 

We see it is difficult to argue from a statistical point of view
where to set the threshold and this is a reason why we have the significance 
threshold as a point of orientation.

The significance threshold is close to the 50% threshold and the structure would
not change upon changing it to that point.

If it is reasonable one can vary from the proposed significance threshold.


```{r cpdag-tabu-strength}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "cpdag_tabu_bic", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT))
  }
  strength.plot(
    cpdag(avg.boot, wlbl = TRUE),
    arcstren[["tabu"]],
    main = "CPDAG",
    sub = "SL: tabu\nth.=sign.level",
    shape = "rectangle"
  )
  dev.off()
} else {
  strength.plot(
    cpdag(avg.boot, wlbl = TRUE),
    arcstren[["tabu"]],
    main = "CPDAG",
    sub = "SL: tabu\nth.=sign.level",
    shape = "rectangle"
  )
}
```

```{r dag-tabu-strength}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "dag_tabu_bic", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT))
  }
  strength.plot(
    avgnet[["tabu"]],
    arcstren[["tabu"]],
    main = "DAG",
    sub = "SL: tabu\nth.=sign.level",
    shape = "rectangle"
  )
  dev.off()
} else {
  strength.plot(
    avgnet[["tabu"]],
    arcstren[["tabu"]],
    main = "DAG",
    sub = "SL: tabu\nth.=sign.level",
    shape = "rectangle"
  )
}
```

As already expected from the arc-strength plot, we see a very sparse, partially
connected CPDAG with no arc directions.

Variables, we know they must have an effect on rupture or at least some other
variables are not connected.

Eventhough methodologically sound, it is difficult to justify this network from
a clinical point of view. 

Interestingly all connections from the CPDAG above were found in the mcmcabn 
consensus DAG as well. 

If we lower the arc-strength threshold to 30% (dashed line in arc-strength plot. 
We result in a fully connected, partially directed CPDAG.

```{r cpdag-tabu-strength-th30, layout="l-page"}
avgnet[["tabu.th03"]] <- averaged.network(arcstren[["tabu"]], threshold = 0.3)


if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "cpdag_tabu_bic_th03", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT))
  }
  strength.plot(
    cpdag(avgnet[["tabu.th03"]], wlbl = TRUE),
    arcstren[["tabu"]],
    main = "CPDAG",
    sub = "SL: tabu\nth.=0.3",
    shape = "rectangle"
  )
  dev.off()
} else {
  strength.plot(
    cpdag(avgnet[["tabu.th03"]], wlbl = TRUE),
    arcstren[["tabu"]],
    main = "CPDAG",
    sub = "SL: tabu\nth.=0.3",
    shape = "rectangle"
  )
}
```

The respective DAG:

```{r}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "dag_tabu_bic_th03", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT))
  }
  strength.plot(avgnet[["tabu.th03"]],
                arcstren[["tabu"]],
                main = "DAG",
                sub = "SL: tabu\nth.=0.3",
                shape = "rectangle")
  dev.off()
  bnlearn::write.dot(graph = avgnet[["tabu.th03"]],
                     file = paste0(FILE, "dot"))
  write.csv(arcstren[["tabu"]], file = paste0(FILE, "csv"))
} else {
  strength.plot(avgnet[["tabu.th03"]],
                arcstren[["tabu"]],
                main = "DAG",
                sub = "SL: tabu\nth.=0.3",
                shape = "rectangle")
  }
```

# Structure Learning with TABU search and custom BIC

There are two possible way to remediate this issue. One is to lower the 
threshold in averaged.network(). However, this is likely to let noisy arcs in
the network and it is difficult to decide how much the threshold should be 
lowered in an objective way. The other is to penalise model complexity less 
harshly so that what were the children have a chance to be significant when they
are included as parents.

AIC has a smaller penalty coefficient than BIC, but the network it gives is too
dense. The CDF plot of the arc strengths makes it really apparent the score is 
overfitting: almost all arcs have non-zero strength.

```{r learn_with_aic, warning=FALSE}
cl = makeCluster(6)

bb = boot.strength(data, algorithm = "tabu", R = 500, cluster = cl, 
       algorithm.args = list(score = "aic", blacklist = bl, tabu = 50))
avg = averaged.network(bb)
strength.plot(avg, bb, shape = "rectangle")
plot(bb)
```

We can of course increase the threshold a bit to prune borderline arcs and paper
over the shortcomings of AIC.

```{r learn_with_aic_and_threshold, warning=FALSE}
avg = averaged.network(bb, threshold = 0.6)
strength.plot(avg, bb, shape = "rectangle")
```

AIC (penalty coefficient = 1) overfits badly, and BIC (penalty coefficient = 
log(n) / 2): the right amount of regularisation is likely to be somewhere in 
between (say the average of the two penalty coefficients).

```{r learn_with_halved_bic, warning=FALSE}
bb = boot.strength(data, algorithm = "tabu", R = 500, cluster = cl, 
       algorithm.args = list(score = "bic", k = (log(nrow(data)) / 2 + 1) /2,
                             blacklist = bl, tabu = 50))
avg = averaged.network(bb)
strength.plot(avg, bb, shape = "rectangle")
stopCluster(cl)
```

The simpler expression log(nrow(data)) / 4 (which is smaller) leads to a network
without isolated components, one that looks sensible in a number of ways.

```{r bootstrap bic custom, echo=FALSE, message=FALSE, warning=FALSE}
cl = makeCluster(6)

# Structure learning with non-parametric bootstrap framework
cl = makeCluster(6)
algo = "tabu"
b = 10000
tabusize = 18
crt = "bic" # BIC standard
priorname = "uniform" # uniform standard
boot <- boot.strength(
  data = data,
  R = b,
  algorithm = algo,
  algorithm.args = list(
    tabu = tabusize,
    blacklist = bl,
    score = crt,
    prior = priorname,
    k = log(nrow(data)) / 4
  ),
  # prior distribution to be used with the various Bayesian Dirichlet scores
  cluster = cl
)
stopCluster(cl)

arcstren[["tabu.bic.custom"]] <- boot

avg.boot <- averaged.network(boot)
avgnet[["tabu.bic.custom"]] <- avg.boot

avg.boot.th0 <- averaged.network(boot, threshold = 0)
avgnet.th0[["tabu.bic.custom"]] <- avg.boot.th0

netmet <- network.metrics(
  data,
  estGraph = avg.boot,
  estGraph.th0 = avg.boot.th0,
  algo = algo,
  tabulistsize = ifelse(algo == "tabu", tabusize, NA),
  b = b,
  trueGraph = ekg,
  crt = crt,
  priorname = priorname
)
```


```{r}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "arcstren_tabu_bic_custom", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT))
  }
  plot(arcstren[["tabu.bic.custom"]])
  # abline(v = 0.3)
  dev.off()
} else {
  plot(arcstren[["tabu.bic.custom"]])
  abline(v=0.3)
}
```



```{r cpdag-tabu-strength-bic-custom}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "cpdag_tabu_bic_custom", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT))
  }
  strength.plot(cpdag(avg.boot, wlbl = TRUE),
              arcstren[["tabu.bic.custom"]],
              main = "CPDAG",
              sub = "SL: tabu\nth.=sign.level\nScore=BIC-custom",
              shape = "rectangle")
  dev.off()
} else {
  strength.plot(cpdag(avg.boot, wlbl = TRUE),
              arcstren[["tabu.bic.custom"]],
              main = "CPDAG",
              sub = "SL: tabu\nth.=sign.level\nScore=BIC-custom",
              shape = "rectangle")
}
```


```{r}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "dag_tabu_bic_custom", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT))
  }
  strength.plot(avgnet[["tabu.bic.custom"]],
                arcstren[["tabu.bic.custom"]],
                main = "DAG",
                sub = "SL: tabu\nth.=sign.level\nScore=BIC-custom",
                shape = "rectangle")
  dev.off()
  bnlearn::write.dot(graph = avgnet[["tabu.bic.custom"]],
                     file = paste0(FILE, "dot"))
  write.csv(arcstren[["tabu"]], file = paste0(FILE, "csv"))
  
} else {
  strength.plot(avgnet[["tabu.bic.custom"]],
                arcstren[["tabu.bic.custom"]],
                main = "DAG",
                sub = "SL: tabu\nth.=sign.level\nScore=BIC-custom",
                shape = "rectangle")
}
```



## save to package data

```{r save avgnet and arcstren}
# discrete_bns <- list(avgnet = avgnet, 
#                      arcstren = arcstren)
# usethis::use_data(discrete_bns, overwrite = TRUE)
# devtools::document()
```
