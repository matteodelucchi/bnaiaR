---
title: "Structure Learning of discrete BN"
author: "Matteo Delucchi"
output:
  rmarkdown::html_document:
    toc: yes
    toc_float:
      collapsed: true
      smooth_scroll: false
    toc_depth: 3
  rmarkdown::html_vignette: default
vignette: >
  %\VignetteIndexEntry{Structure Learning of discrete BN}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r development, eval=FALSE, include=FALSE}
# devtools::document()
# devtools::load_all()
# renv::snapshot(prompt = F)
```


```{r setup}
# Clear working environment
rm(list=ls())

library(bnaiaR)
library(dplyr)
library(ggplot2)
library(bnlearn)
library(doParallel)

set.seed(100)

SAVEPLOTS <- T
PLOTPATH <- Sys.getenv("PLOTPATH")
PLOTFORMAT <- "pdf" # "svg", "png"
PLOTWIDTH = 16
PLOTHEIGHT = 9

cores <- 60 
```

# Structure Learning of discrete BN


```{r}
data("exp1_dat")
data.dbn <- exp1_dat$abndata %>%
  filter(positive_famillial_history != "probably") %>%
  mutate(positive_famillial_history = factor(positive_famillial_history, levels = c("no", "yes")))
dist.dbn <- exp1_dat$dist
banned.dbn <- exp1_dat$banned
bl.dbn <- exp1_dat$bl

str(data.dbn)
print(bl.dbn)
```

Nothing can point to study source.


```{r learn_with_aic, warning=FALSE}
cl = makeCluster(cores)

bb = boot.strength(data.dbn, 
                   algorithm = "tabu", 
                   R = 500,
                   cluster = cl, 
                   algorithm.args = list(score = "aic", 
                                         blacklist = bl.dbn,
                                         tabu = 50))
avg = averaged.network(bb)
```


```{r, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_aic", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(1,2))
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
  dev.off()
} else {
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
}
```

We can of course increase the threshold a bit to prune borderline arcs and paper
over the shortcomings of AIC.

```{r learn_with_aic_and_threshold, warning=FALSE}
avg = averaged.network(bb, threshold = 0.4)

if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_aic_redTH", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  strength.plot(avg, bb, shape = "rectangle")
} else {
  strength.plot(avg, bb, shape = "rectangle")
}
```




```{r learn_with_bic, warning=FALSE}
bb = boot.strength(data.dbn, 
                   algorithm = "tabu", 
                   R = 500,
                   cluster = cl, 
                   algorithm.args = list(score = "bic", 
                                         blacklist = bl.dbn,
                                         tabu = 50))
avg = averaged.network(bb)
```

```{r, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_bic", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(1,2))
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
  dev.off()
} else {
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
}
```

```{r, warning=FALSE}
avg = averaged.network(bb, threshold = 0.3)

if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_bic_redTH", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  strength.plot(avg, bb, shape = "rectangle")
} else {
  strength.plot(avg, bb, shape = "rectangle")
}
```

```{r}
parallel::stopCluster(cl)
```

# Structure Learning of discrete BN w/o study_source


```{r}
data("exp1_dat")
data.dbn.nostudy <- exp1_dat$abndata %>%
  select(-c(study_source)) %>%
  filter(positive_famillial_history != "probably") %>%
  mutate(positive_famillial_history = factor(positive_famillial_history, levels = c("no", "yes")))
bl.dbn.nostudy <- exp1_dat$bl %>%
  filter(From != "study_source" & To != "study_source")

str(data.dbn.nostudy)
print(bl.dbn.nostudy)
```

```{r learn_with_aic, warning=FALSE}
cl = makeCluster(cores)

bb = boot.strength(data.dbn.nostudy, 
                   algorithm = "tabu", 
                   R = 500,
                   cluster = cl, 
                   algorithm.args = list(score = "aic", 
                                         blacklist = bl.dbn.nostudy,
                                         tabu = 50))
avg = averaged.network(bb)
```

```{r, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_nostudysource_aic", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(1,2))
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
  dev.off()
} else {
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
}
```

```{r, warning=FALSE}
avg = averaged.network(bb, threshold = 0.5)

if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_nostudysource_aic_redTH", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  strength.plot(avg, bb, shape = "rectangle")
} else {
  strength.plot(avg, bb, shape = "rectangle")
}
```



```{r learn_with_bic, warning=FALSE}
bb = boot.strength(data.dbn.nostudy, 
                   algorithm = "tabu", 
                   R = 500,
                   cluster = cl, 
                   algorithm.args = list(score = "bic", 
                                         blacklist = bl.dbn.nostudy,
                                         tabu = 50))
avg = averaged.network(bb)
```

```{r, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_nostudysource_bic", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(1,2))
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
  dev.off()
} else {
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
}
```

```{r, warning=FALSE}
avg = averaged.network(bb, threshold = 0.4)

if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_nostudysource_bic_redTH", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  strength.plot(avg, bb, shape = "rectangle")
} else {
  strength.plot(avg, bb, shape = "rectangle")
}
```

```{r}
parallel::stopCluster(cl)
```


# Structure Learning of discrete BN w/o study_source for each source individually


```{r}
data("exp1_dat")
data.dbn <- exp1_dat$abndata  %>%
  filter(positive_famillial_history != "probably") %>%
  mutate(positive_famillial_history = factor(positive_famillial_history, levels = c("no", "yes")))
bl.dbn.nostudy <- exp1_dat$bl %>%
  filter(From != "study_source" & To != "study_source")

str(data.dbn)
print(bl.dbn.nostudy)
```


```{r learn_with_aic, warning=FALSE}
cl = parallel::makeCluster(4)
bb_studies_aic <- list()
bb_studies_bic <- list()

for (study in unique(data.dbn$study_source)){
  message(paste("Working on study centre: ", study))

  
  # Filter data set for current study only
  data.dbn.partial <- data.dbn %>%
    filter(study_source == study) %>%
    select(-c(study_source))
  
  # learn BN
  message("\twith tabu and AIC...")
  bb_studies_aic[[study]] = boot.strength(data.dbn.partial, 
                                      algorithm = "tabu", 
                                      R = 500,
                                      cluster = cl,
                                      algorithm.args = list(score = "aic", 
                                                            blacklist = bl.dbn.nostudy,
                                                            tabu = 50))
  
  message("\twith tabu and BIC...")
  bb_studies_bic[[study]] = boot.strength(data.dbn.partial, 
                                      algorithm = "tabu", 
                                      R = 500,
                                      cluster = cl,
                                      algorithm.args = list(score = "bic", 
                                                            blacklist = bl.dbn.nostudy,
                                                            tabu = 50))
}
parallel::stopCluster(cl)

# Collect all BNs in one list of scores : studies : BNs
bb_studies <- list("aic" = bb_studies_aic, "bic" = bb_studies_bic)
```


```{r learn_with_aic, warning=FALSE}
avg_studies = list()
# print all AIC BNs
for (score in names(bb_studies)){
  for(study in names(bb_studies[[score]])){
    bb <- bb_studies[[score]][[study]]
    avg = averaged.network(bb, threshold = 0.2)
    avg_studies[[score]][[study]] <- avg
    
    if (SAVEPLOTS) {
    FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_per_studysource_", score, "_", study, ".")
    if (PLOTFORMAT == "svg") {
      svg(paste0(FILE, PLOTFORMAT))
    } else if (PLOTFORMAT == "png") {
      png(paste0(FILE, PLOTFORMAT))
    } else if (PLOTFORMAT == "pdf") {
      pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
    }
    par(mfrow=c(1,2))
    strength.plot(avg, bb, shape = "rectangle", main = paste(score, study))
    plot(bb, main = paste(score, study))
    dev.off()
  } else {
    strength.plot(avg, bb, shape = "rectangle", main = paste(score, study))
    plot(bb, main = paste(score, study))
  }
  }
}
```

```{r compare_plot_aic, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_per_studysource_aic_compareplt", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(3,3))
  graphviz.compare(avg_studies[[1]][[1]], 
                 avg_studies[[1]][[2]], 
                 avg_studies[[1]][[3]], 
                 avg_studies[[1]][[4]], 
                 avg_studies[[1]][[5]], 
                 avg_studies[[1]][[6]], 
                 avg_studies[[1]][[7]], 
                 main = c(paste(names(avg_studies)[1], names(avg_studies[[1]])[1]),
                          paste(names(avg_studies)[1], names(avg_studies[[1]])[2]),
                          paste(names(avg_studies)[1], names(avg_studies[[1]])[3]),
                          paste(names(avg_studies)[1], names(avg_studies[[1]])[4]),
                          paste(names(avg_studies)[1], names(avg_studies[[1]])[5]), 
                          paste(names(avg_studies)[1], names(avg_studies[[1]])[6]), 
                          paste(names(avg_studies)[1], names(avg_studies[[1]])[7])), 
                 diff = "none", 
                 shape = "rectangle")
dev.off()
} else {
  graphviz.compare(avg_studies[[2]][[1]], 
                 avg_studies[[2]][[2]], 
                 avg_studies[[2]][[3]], 
                 avg_studies[[2]][[4]], 
                 avg_studies[[2]][[5]], 
                 avg_studies[[2]][[6]], 
                 avg_studies[[2]][[7]], 
                 main = c(paste(names(avg_studies)[2], names(avg_studies[[2]])[1]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[2]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[3]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[4]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[5]), 
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[6]), 
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[7])), 
                 diff = "none", 
                 shape = "rectangle")
}
```


```{r compare_plot_bic, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_per_studysource_bic_compareplt", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(3,3))
  graphviz.compare(avg_studies[[2]][[1]], 
                 avg_studies[[2]][[2]], 
                 avg_studies[[2]][[3]], 
                 avg_studies[[2]][[4]], 
                 avg_studies[[2]][[5]], 
                 avg_studies[[2]][[6]], 
                 avg_studies[[2]][[7]], 
                 main = c(paste(names(avg_studies)[2], names(avg_studies[[2]])[1]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[2]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[3]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[4]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[5]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[6]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[7])), 
                 diff = "none", 
                 shape = "rectangle")
  dev.off()
} else {
  graphviz.compare(avg_studies[[2]][[1]], 
                 avg_studies[[2]][[2]], 
                 avg_studies[[2]][[3]], 
                 avg_studies[[2]][[4]], 
                 avg_studies[[2]][[5]], 
                 avg_studies[[2]][[6]], 
                 avg_studies[[2]][[7]], 
                 main = c(paste(names(avg_studies)[2], names(avg_studies[[2]])[1]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[2]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[3]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[4]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[5]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[6]),
                          paste(names(avg_studies)[2], names(avg_studies[[2]])[7])), 
                 diff = "none", 
                 shape = "rectangle")
}
```


# Structure Learning of discrete BN with study source as parent of everything

```{r}
data("exp1_dat")
data.dbn.allstudy <- exp1_dat$abndata %>%
  filter(positive_famillial_history != "probably") %>%
  mutate(positive_famillial_history = factor(positive_famillial_history, levels = c("no", "yes")))
bl.dbn.allstudy <- exp1_dat$bl %>%
  filter(From != "study_source" & To != "study_source") 

wl.dbn.allstudy <- data.frame("From" = rep("study_source", length(names(data.dbn.allstudy))), "To" = names(data.dbn.allstudy)) %>%
  filter(To != "study_source") # Study source can not influence itself

str(data.dbn.allstudy)
print(bl.dbn.allstudy)
print(wl.dbn.allstudy)
```


```{r learn_with_aic, warning=FALSE}
cl = makeCluster(cores)

bb = boot.strength(data.dbn.allstudy, 
                   algorithm = "tabu", 
                   R = 500,
                   cluster = cl, 
                   algorithm.args = list(score = "aic", 
                                         blacklist = bl.dbn.allstudy,
                                         whitelist = wl.dbn.allstudy,
                                         tabu = 50))
avg = averaged.network(bb)
```

```{r, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_studysourceASparent_aic", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(1,2))
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
  dev.off()
} else {
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
}
```

```{r, warning=FALSE}
avg = averaged.network(bb, threshold = 0.3)

if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_studysourceASparent_aic_redTH", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  strength.plot(avg, bb, shape = "rectangle")
} else {
  strength.plot(avg, bb, shape = "rectangle")
}
```




```{r learn_with_bic, warning=FALSE}
bb = boot.strength(data.dbn.allstudy, 
                   algorithm = "tabu", 
                   R = 500,
                   cluster = cl, 
                   algorithm.args = list(score = "bic", 
                                         blacklist = bl.dbn.allstudy,
                                         whitelist = wl.dbn.allstudy,
                                         tabu = 50))
avg = averaged.network(bb)
```

```{r, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_studysourceASparent_bic", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(1,2))
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
  dev.off()
} else {
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
}
```

```{r}
parallel::stopCluster(cl)
```

# additive discrete BN

```{r}
data("exp1_dat")
data.dbn.nostudy <- exp1_dat$abndata %>%
  select(-c(study_source)) 
bl.dbn.nostudy <- exp1_dat$bl %>%
  filter(From != "study_source" & To != "study_source")

dist.dbn.nostudy <- exp1_dat$dist

str(data.dbn.nostudy)
print(bl.dbn.nostudy)
print(dist.dbn.nostudy)
```

```{r just to test should be same as above}
wtable = function(x, y, w) {
   # normalize the weights to sum up to the sample size.
   w = w / sum(w) * length(w)
   # tally the weights.
   if (missing(y))
     tab = tapply(w, list(x), sum)
   else
     tab = tapply(w, list(x, y), sum)
   # unobserved combinations of values are tabulated as zeros.
   tab[is.na(tab)] = 0
   return(as.table(tab))
}#WTABLE

weighted.bic = function(node, parents, data, args) {
   n = nrow(data)
   w = args$weights
   if (length(parents) == 0) {
     counts = wtable(data[, node], w = w)
     nparams = dim(counts) - 1
     sum(counts * log(counts / n)) - nparams * log(n) / 2
   }#THEN
   else {
     counts = wtable(data[, node], configs(data[, parents, drop = FALSE]), w = w)
     nparams = ncol(counts) * (nrow(counts) - 1)
     sum(counts * log(prop.table(counts, 2))) - nparams * log(n) / 2
   }#ELSE

}#WEIGHTED.BIC

bb = boot.strength(data.dbn.nostudy, 
                   algorithm = "tabu", 
                   R = 500,
                   # cluster = cl, 
                   algorithm.args = list(score = "custom",
                                         fun = weighted.bic,
                                         blacklist = bl.dbn.nostudy,
                                         args = list(weights = rep(1, nrow(data.dbn.nostudy))),
                                         # whitelist = wl.dbn.allstudy,
                                         tabu = 50))
avg = averaged.network(bb)
strength.plot(avg, bb, shape = "rectangle")
plot(bb)
```


```{r additive discrete BN w/o mixed effects}
cl = makeCluster(cores)

glm.bic = function(node, parents, data, args) {
  dist = args$dist
  
  if (length(parents) == 0)
    model = as.formula(paste(node, "~ 1"))
  else
    model = as.formula(paste(node, "~", paste(parents, collapse = "+")))
  
  if (dist[[node]] == "gaussian")
     - BIC(glm(model, data = data, family = "gaussian")) / 2
   else if (dist[[node]] == "binomial")
     - BIC(glm(model, data = data, family = "binomial")) / 2
  else if (dist[[node]] == "multinomial") 
    # - BIC(glm(model, data = data, family = dist[[node]])) / 2
    -BIC(nnet::multinom(formula = model, data = data)) / 2
 }#GLM.BIC

bb = boot.strength(data.dbn.nostudy, 
                   algorithm = "tabu", 
                   R = 500,
                   cluster = cl,
                   algorithm.args = list(score = "custom",
                                         fun = glm.bic,
                                         blacklist = bl.dbn.nostudy,
                                         # whitelist = wl.dbn.allstudy,
                                         args = list(dist = dist.dbn.nostudy),
                                         tabu = 50))
avg = averaged.network(bb)
```

```{r, warning=FALSE}
if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_additive_bic", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(1,2))
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
  dev.off()
} else {
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
}
```

```{r}
parallel::stopCluster(cl)
```

# additive discrete BN with study source as mixed effect


```{r}
data("exp1_dat")
data.dbn.additive <- exp1_dat$abndata  
bl.dbn.additive <- exp1_dat$bl %>%
  filter((From != "study_source") & (To != "study_source")) %>%
  # Nothing can point to study source.
  rbind(., data.frame(From = names(data.dbn.additive), To = rep("study_source", length(names(data.dbn.additive))))) %>%
  filter(!(From == "study_source" & To == "study_source"))

dist.dbn.additive <- exp1_dat$dist

str(data.dbn.additive)
print(bl.dbn.additive)
print(dist.dbn.additive)
```

```{r}
# cl = makeCluster(6)
cl = makeCluster(cores, outfile = path.expand(paste0(getwd(), "/glmm.bic.out")))
```


```{r debugging glmm.bic}
# glmm.bic(node = "age_diag_group", parents = c("positive_famillial_history"), data = data.dbn.additive, args = list(dist = dist.dbn.additive, mixed_effect = "study_source"))
# mod <- glmm.bic(node = "age_diag_group", parents = c("gender"), data = data.dbn.additive, args = list(dist = dist.dbn.additive, mixed_effect = "study_source"))
# glmm.bic(node = "gender", parents = c("study_source"), data = data.dbn.additive, args = list(dist = dist.dbn.additive, mixed_effect = "study_source"))
# mod <- glmm.bic(node = "IAruptured", parents = c("age_diag_group", "hpt_aware", "IAlocation_group"), data = data.dbn.additive, args = list(dist = dist.dbn.additive, mixed_effect = "study_source"))
# mod <- glmm.bic(node = "IAruptured", parents = c(), data = data.dbn.additive, args = list(dist = dist.dbn.additive, mixed_effect = "study_source"))
# mod <- glmm.bic(node = "positive_famillial_history", parents = c("gender"), data = data.dbn.additive, args = list(dist = dist.dbn.additive, mixed_effect = "study_source"))
# mod <- glmm.bic(node = "IAlocation_group", parents = c("gender", "hpt_aware", "IAsize_diag_grouped_merged","multipleIAs"), data = data.dbn.additive, args = list(dist = dist.dbn.additive, mixed_effect = "study_source"))
# mod <- glmm.bic(node = "IAsize_diag_grouped_merged", parents = c("gender", "positive_famillial_history", "age_diag_group", "smoking_current_notcurrent", "IAlocation_group", "hpt_aware", "multipleIAs", "IAruptured", "study_source"), data = data.dbn.additive, args = list(dist = dist.dbn.additive, mixed_effect = "study_source"))
# mod <- glmm.bic(node = "IAsize_diag_grouped_merged", parents=c(), data = data.dbn.additive, args = list(dist = dist.dbn.additive, mixed_effect = "study_source"))
# mod
# -BIC(NULL) / 2
```


```{r additive discrete BN w/ mixed effects}
stime <- Sys.time()

bb = boot.strength(data.dbn.additive, 
                   algorithm = "tabu", 
                   R = 500,
                   cluster = cl,
                   algorithm.args = list(score = "custom",
                                         fun = glmm.bic,
                                         blacklist = bl.dbn.additive,
                                         # whitelist = wl.dbn.allstudy,
                                         args = list(dist = dist.dbn.additive,
                                                     mixed_effect = "study_source"),
                                         tabu = 50),
                   debug = TRUE)
stopCluster(cl)
etime <- Sys.time()
running_time <- etime-stime
print(paste("Running time: ", running_time))
```


```{r additive discrete BN w/ mixed effects}
avg = averaged.network(bb)

if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_additive_bic_mixedeffects", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(1,2))
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
  dev.off()
} else {
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
}
```


```{r}
tobesaved <- list("madbn_data"=data.dbn.additive, "madbn_bl"=bl.dbn.additive, "madbn_dists"=dist.dbn.additive, "madbn_boot"=bb, "madbn_avg"=avg)
save(tobesaved,file = paste0(PLOTPATH, "/discrete_BN_SL_additive_bic_mixedeffects.RData"))
```

# additive discrete BN with study source as mixed effect. Size -> location restricted


```{r}
data("exp1_dat")
data.dbn.additive <- exp1_dat$abndata  
bl.dbn.additive.sizeloc <- exp1_dat$bl %>%
  filter((From != "study_source") & (To != "study_source")) %>%
  # Nothing can point to study source.
  rbind(., data.frame(From = names(data.dbn.additive), To = rep("study_source", length(names(data.dbn.additive))))) %>%
  filter(!(From == "study_source" & To == "study_source")) %>%
  # Size can not point to Location
  rbind(., data.frame(From = "IAsize_diag_grouped_merged", To = "IAlocation_group"))

dist.dbn.additive <- exp1_dat$dist

str(data.dbn.additive)
print(bl.dbn.additive.sizeloc)
print(dist.dbn.additive)
```

```{r}
# cl = makeCluster(6)
cl = makeCluster(cores, outfile = path.expand(paste0(getwd(), "/glmm.bic.1.7.out")))
```


```{r additive discrete BN w/ mixed effects size-loc restricted}
stime <- Sys.time()

bb = boot.strength(data.dbn.additive, 
                   algorithm = "tabu", 
                   R = 500,
                   cluster = cl,
                   algorithm.args = list(score = "custom",
                                         fun = glmm.bic,
                                         blacklist = bl.dbn.additive.sizeloc,
                                         args = list(dist = dist.dbn.additive,
                                                     mixed_effect = "study_source"),
                                         tabu = 50),
                   debug = TRUE)
stopCluster(cl)
etime <- Sys.time()
running_time <- etime-stime
print(paste("Running time: ", running_time))
```


```{r additive discrete BN w/ mixed effects}
avg = averaged.network(bb)

if (SAVEPLOTS) {
  FILE <- paste0(PLOTPATH, "/", "discrete_BN_SL_additive_bic_mixedeffects_restrictedSizeLoc", ".")
  if (PLOTFORMAT == "svg") {
    svg(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "png") {
    png(paste0(FILE, PLOTFORMAT))
  } else if (PLOTFORMAT == "pdf") {
    pdf(paste0(FILE, PLOTFORMAT), width = PLOTWIDTH, height = PLOTHEIGHT)
  }
  par(mfrow=c(1,2))
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
  dev.off()
} else {
  strength.plot(avg, bb, shape = "rectangle")
  plot(bb)
}
```


```{r}
tobesaved <- list("madbn_data"=data.dbn.additive, "madbn_bl"=bl.dbn.additive.sizeloc, "madbn_dists"=dist.dbn.additive, "madbn_boot"=bb, "madbn_avg"=avg)
save(tobesaved,file = paste0(PLOTPATH, "/discrete_BN_SL_additive_bic_mixedeffects_restrictedSizeLoc.RData"))
```



