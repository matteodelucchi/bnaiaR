---
title: "Data Preparation for Different Analysis Scenario"
author: "Matteo Delucchi"
output:
  rmarkdown::html_document:
    toc: yes
    toc_float:
      collapsed: true
      smooth_scroll: false
    toc_depth: 3
  rmarkdown::html_vignette: default
vignette: >
  %\VignetteIndexEntry{Data Preparation for Different Analysis Scenario}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
# Clear working environment
rm(list=ls())

# Load libraries
library(bnaiaR)
library(tidyr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(RMariaDB)
library(forcats)

# Save plots as files? 
# Warning: Bad layout with knitr. Works well if chunks are run without rendering.
SAVEPLOTS <- FALSE
PLOTPATH <- Sys.getenv("PLOTPATH")
```

# Load Preprocessed Data

```{r load_data}
data("adbisgc")
str(adbisgc, give.attr=F)
# summarytools::dfSummary(adbisgc)
```

```{r}
adbisgc_reg <- adbisgc %>%
  mutate(gender = fct_relevel(gender,c("male","female"))) %>%
  # mutate(age_diag_group = fct_relevel(age_diag_group, c(LETTERS[seq(8,1,-1)]))) %>% # keep them alphabetically.
  mutate(positive_famillial_history = fct_relevel(positive_famillial_history, c("no", "probably", "yes"))) %>%
  mutate(smoking_current_former_no = fct_relevel(smoking_current_former_no, c("no","former","current"))) %>%
  mutate(smoking_current_notcurrent = fct_relevel(smoking_current_notcurrent, c("not_current", "current"))) %>%
  mutate(multipleIAs = fct_relevel(multipleIAs, c("no", "yes"))) %>%
  mutate(hpt_aware = fct_relevel(hpt_aware,c("no","yes"))) %>%
  mutate(IAlocation_group = fct_relevel(IAlocation_group, c("low","medium","high")))%>%
  mutate(IAruptured = fct_relevel(IAruptured,c("no","yes"))) 
  # mutate(IAsize_diag_grouped_merged = fct_relevel(IAsize_diag_grouped_merged, c(LETTERS[seq(3,1,-1)])))
str(adbisgc_reg, give.attr=F)
# summarytools::dfSummary(adbisgc_reg)
```


## Select bnaiaR variables


```{r}
bnaiar_vars <- c("ID_1", 
           "study_source", 
           "gender", 
           "age_diag", "age_diag_group", 
           "positive_famillial_history", 
           "hpt_aware", 
           "smoking_current_notcurrent", 
           "multipleIAs", 
           "IAlocation", "IAlocation_group", 
           "IAsize_diag", "IAsize_diag_log", "IAsize_diag_grouped", "IAsize_diag_grouped_merged",
           "IAruptured")

df_bnaiar <- adbisgc_reg %>%
  select(all_of(bnaiar_vars))
```

```{r}
# summarytools::dfSummary(df_bnaiar)
# summarytools::view(dfSummary(df_bnaiar), method = "pander", file = "~/ZHAW/ExplorDataISGC/220623_HUG-ZHAW_Retreat/summary_adbisgc_bnaiaR.html")
str(df_bnaiar, give.attr=F)
```


## bnaiaR vars with only complete entries

```{r}
df_bnaiar_compl <- df_bnaiar %>%
  na.omit() 

summarytools::dfSummary(df_bnaiar_compl)
```


# Experiment 1: discrete data

For discrete BNs we obviously use just discrete variables.
Because conditional linear Gaussian Bayesian networks do not allow continuous nodes 
to be parents of discrete nodes. Which might be an issue in our case, for IA-size
which is not a priori expected to be a root node.

Age: discrete  
Location: grouped by risk of rupture  
Size: discrete and merged (see vignette `data_preprocessing` for details)  

```{r}
exp1_dat <- prep_exp_data(
  dat = df_bnaiar_compl,
  EXPNO = 1,
  age = "disc.grouped-multinomial",
  location = "byRisk-multinomial",
  size = "grouped.merged-multinomial",
  smoking = "binCnC",
  SAVE = F)
```

The prepared data is returned as list of inputs for the following 
BN modeling:

```{r}
abndata <- exp1_dat$abndata
dist <- exp1_dat$dist
banned <- exp1_dat$banned
bl <- exp1_dat$bl

str(abndata)
str(dist)
str(banned)
str(bl)
```

```{r}
# usethis::use_data(exp1_dat, overwrite = TRUE)
```

# Experiment 4: Continuous data

With additive Bns we can combine continuous and discrete variables.

Age: continuous
Location: grouped by risk of rupture
Size: continuous, log-transformed

```{r}
exp4_dat <- prep_exp_data(
  dat = df_bnaiar_compl,
  EXPNO = 4,
  age = "cont",
  location = "byRisk-multinomial",
  size = "log",
  smoking = "binCnC",
  studysource.restriction = "blockalltowards",
  SAVE = F)
```

The prepared data is returned as list of inputs for the following 
BN modeling:

```{r}
abndata <- exp4_dat$abndata
dist <- exp4_dat$dist
banned <- exp4_dat$banned
bl <- exp4_dat$bl
retain <- exp4_dat$retain
wl <- exp4_dat$wl

str(abndata)
str(dist)
str(banned)
str(bl)
str(retain)
str(wl)
```

```{r}
# usethis::use_data(exp4_dat, overwrite = TRUE)
```

```{r}
exp44_dat <- prep_exp_data(
  dat = df_bnaiar_compl,
  EXPNO = 44, 
  age = "cont",
  location = "byRisk-multinomial",
  size = "log",
  smoking = "binCnC",
  studysource.restriction = "forceasparent",
  SAVE = F)
```

```{r}
str(exp44_dat$abndata)
str(exp44_dat$dist)
str(exp44_dat$banned)
str(exp44_dat$bl)
str(exp44_dat$retain)
str(exp44_dat$wl)
```

```{r}
# usethis::use_data(exp44_dat, overwrite = TRUE)
```


# Some internal checks

Test if data sets correspond to earlier implementation:

```{r}
# load("../../BNstructureLearning/210831_TrilateralStatusupdate_MCMCABNvsTabu/exp29_data.RData")
# str(abndata)
# str(exp11_dat$abndata)
# 
# sum(abndata != exp11_dat$abndata) == 0
```


```{r}
# load("../../BNstructureLearning/ABNAIA/results/analysis/100k_mcmcruns/exp6_100k_analysis_results.RData")
# str(abndata)
# str(exp06_dat$abndata)
# 
# sum(abndata != exp06_dat$abndata) == 0
```

```{r}
# devtools::document()
# devtools::load_all()
```

